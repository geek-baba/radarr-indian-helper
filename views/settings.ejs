<!DOCTYPE html>
<html lang="en" class="<%= typeof theme !== 'undefined' && theme === 'dark' ? 'dark' : '' %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings — desiarr</title>
  <link rel="icon" type="image/svg+xml" href="/assets/desiarr-logo.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/app.css">
  <style>
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    .toast-enter {
      animation: slideIn 0.3s ease-out;
    }
    .toast-exit {
      animation: slideOut 0.3s ease-in;
    }
  </style>
</head>
<body class="bg-[var(--bg)] text-[var(--text)] min-h-screen">
  <%- include('partials/app-sidebar', { currentPage: 'settings' }) %>
  
  <div class="lg:pl-64">
    <%- include('partials/app-header') %>
    
    <main class="p-4 lg:p-6">
    <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Settings</h2>

    <!-- Tab Navigation -->
    <div class="mb-6">
      <nav class="flex flex-wrap gap-2" role="tablist">
        <button
          id="tab-rss"
          onclick="switchTab('rss')"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-blue-500 text-white shadow-sm hover:bg-blue-600 active-tab"
          role="tab"
          aria-selected="true"
        >
          RSS Feeds
        </button>
        <button
          id="tab-api"
          onclick="switchTab('api')"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600"
          role="tab"
          aria-selected="false"
        >
          Connections
        </button>
        <button
          id="tab-quality"
          onclick="switchTab('quality')"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600"
          role="tab"
          aria-selected="false"
        >
          Quality Settings
        </button>
      </nav>
    </div>

    <!-- RSS Feeds Section -->
    <div id="section-rss" class="tab-content">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
      <div class="mb-4">
        <button onclick="showAddFeedModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
          Add Feed
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full table-fixed divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-1/6">Name</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-2/5">URL</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-1/12">Type</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-1/12">Enabled</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-1/6">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% feeds.forEach(feed => { %>
              <tr>
                <td class="px-4 py-3 text-sm"><%= feed.name %></td>
                <td class="px-4 py-3 text-sm text-gray-600">
                  <div class="truncate" title="<%= feed.url %>">
                    <%= feed.url %>
                  </div>
                </td>
                <td class="px-4 py-3 text-sm">
                  <span class="px-2 py-1 text-xs rounded-full <%= feed.feed_type === 'tv' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800' %>">
                    <%= feed.feed_type === 'tv' ? 'TV' : 'Movie' %>
                  </span>
                </td>
                <td class="px-4 py-3 text-sm">
                  <span class="<%= feed.enabled ? 'text-green-600' : 'text-red-600' %>">
                    <%= feed.enabled ? 'Yes' : 'No' %>
                  </span>
                </td>
                <td class="px-4 py-3 text-sm space-x-2">
                  <button onclick="editFeed(<%= feed.id %>)" class="text-blue-600 hover:text-blue-800">Edit</button>
                  <button onclick="deleteFeed(<%= feed.id %>)" class="text-red-600 hover:text-red-800">Delete</button>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
    </div>

    <!-- Connections Section -->
    <div id="section-api" class="tab-content hidden">
    <div class="space-y-4">
      <p class="text-sm text-gray-600 dark:text-gray-400">
        Manage service connections for Radarr, Sonarr, and enrichment APIs. Click <strong>Edit</strong> on any card to reveal credentials. Sensitive values stay hidden until you toggle “Show”.
      </p>

      <% const radarrConfigured = radarrApiUrl && radarrApiKey; %>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4">
        <div class="flex flex-wrap items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 font-semibold">Radarr</div>
            <div class="flex items-center gap-2 mt-1">
              <span class="text-sm font-semibold text-gray-900 dark:text-gray-100"><%= radarrConfigured ? 'Connected' : 'Not configured' %></span>
              <span class="px-2 py-0.5 text-[11px] rounded-full <%= radarrConfigured ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700' %>">
                <%= radarrConfigured ? 'Healthy' : 'Action needed' %>
              </span>
            </div>
            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1 break-all"><%= radarrApiUrl || 'No API URL configured' %></p>
          </div>
          <div class="flex gap-2">
            <button type="button" data-connection-toggle="radarr" onclick="toggleConnectionEdit('radarr')" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700">
              <span class="edit-btn-label">Edit</span>
            </button>
          </div>
        </div>
        <form id="radarrForm" onsubmit="saveRadarrConfig(event)" class="mt-4 hidden connection-form space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Radarr API URL</label>
            <input 
              type="url" 
              id="radarrApiUrl" 
              name="radarrApiUrl" 
              value="<%= radarrApiUrl %>" 
              placeholder="http://10.10.10.20:7880/api/v3"
              required
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-900"
            >
            <p class="text-xs text-gray-500 mt-1">Full URL including /api/v3</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Radarr API Key</label>
            <div class="relative">
              <input 
                type="password" 
                id="radarrApiKey" 
                name="radarrApiKey" 
                value="<%= radarrApiKey %>" 
                placeholder="Enter Radarr API Key"
                required
                class="w-full px-3 py-2 pr-16 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-900"
              >
              <button type="button" class="absolute inset-y-0 right-2 text-xs font-semibold text-purple-600 dark:text-purple-300" onclick="toggleSecret('radarrApiKey', this)">Show</button>
            </div>
          </div>
          <div class="flex gap-3">
            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
              Save Radarr Configuration
            </button>
            <button type="button" class="px-4 py-2 rounded-lg border text-sm font-medium" onclick="toggleConnectionEdit('radarr')">Cancel</button>
          </div>
        </form>
      </div>

      <% const sonarrConfigured = sonarrApiUrl && sonarrApiKey; %>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4">
        <div class="flex flex-wrap items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 font-semibold">Sonarr</div>
            <div class="flex items-center gap-2 mt-1">
              <span class="text-sm font-semibold text-gray-900 dark:text-gray-100"><%= sonarrConfigured ? 'Connected' : 'Not configured' %></span>
              <span class="px-2 py-0.5 text-[11px] rounded-full <%= sonarrConfigured ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700' %>">
                <%= sonarrConfigured ? 'Healthy' : 'Action needed' %>
              </span>
            </div>
            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1 break-all"><%= sonarrApiUrl || 'No API URL configured' %></p>
          </div>
          <button type="button" data-connection-toggle="sonarr" onclick="toggleConnectionEdit('sonarr')" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700">
            <span class="edit-btn-label">Edit</span>
          </button>
        </div>
        <form id="sonarrForm" onsubmit="saveSonarrConfig(event)" class="mt-4 hidden connection-form space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Sonarr API URL</label>
            <input 
              type="url"
              id="sonarrApiUrl"
              name="sonarrApiUrl"
              value="<%= sonarrApiUrl %>"
              placeholder="http://10.10.10.20:8989/api/v3"
              required
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-900"
            >
            <p class="text-xs text-gray-500 mt-1">Full URL including /api/v3</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Sonarr API Key</label>
            <div class="relative">
              <input 
                type="password"
                id="sonarrApiKey"
                name="sonarrApiKey"
                value="<%= sonarrApiKey %>"
                placeholder="Enter Sonarr API Key"
                required
                class="w-full px-3 py-2 pr-16 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-900"
              >
              <button type="button" class="absolute inset-y-0 right-2 text-xs font-semibold text-indigo-600 dark:text-indigo-300" onclick="toggleSecret('sonarrApiKey', this)">Show</button>
            </div>
          </div>
          <div class="flex gap-3">
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
              Save Sonarr Configuration
            </button>
            <button type="button" class="px-4 py-2 rounded-lg border text-sm font-medium" onclick="toggleConnectionEdit('sonarr')">Cancel</button>
          </div>
        </form>
      </div>

      <% const tvdbConfigured = tvdbApiKey; %>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4">
        <div class="flex flex-wrap items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 font-semibold">TVDB</div>
            <div class="flex items-center gap-2 mt-1">
              <span class="text-sm font-semibold text-gray-900 dark:text-gray-100"><%= tvdbConfigured ? 'Connected' : 'Not configured' %></span>
              <span class="px-2 py-0.5 text-[11px] rounded-full <%= tvdbConfigured ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700' %>">
                <%= tvdbConfigured ? 'Ready' : 'Action needed' %>
              </span>
            </div>
            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Used for TV metadata enrichment.</p>
          </div>
          <button type="button" data-connection-toggle="tvdb" onclick="toggleConnectionEdit('tvdb')" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700">
            <span class="edit-btn-label">Edit</span>
          </button>
        </div>
        <form id="tvdbForm" onsubmit="saveTvdbConfig(event)" class="mt-4 hidden connection-form space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">TVDB API Key</label>
            <div class="relative">
              <input 
                type="password"
                id="tvdbApiKey"
                name="tvdbApiKey"
                value="<%= tvdbApiKey %>"
                placeholder="Enter TVDB API Key"
                required
                class="w-full px-3 py-2 pr-16 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-teal-500 dark:bg-gray-900"
              >
              <button type="button" class="absolute inset-y-0 right-2 text-xs font-semibold text-teal-600 dark:text-teal-300" onclick="toggleSecret('tvdbApiKey', this)">Show</button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">TVDB User PIN (optional)</label>
            <div class="relative">
              <input 
                type="password"
                id="tvdbUserPin"
                name="tvdbUserPin"
                value="<%= tvdbUserPin %>"
                placeholder="Enter TVDB User PIN if using account-specific data"
                class="w-full px-3 py-2 pr-16 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-teal-500 dark:bg-gray-900"
              >
              <button type="button" class="absolute inset-y-0 right-2 text-xs font-semibold text-teal-600 dark:text-teal-300" onclick="toggleSecret('tvdbUserPin', this)">Show</button>
            </div>
          </div>
          <div class="flex gap-3">
            <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
              Save TVDB Credentials
            </button>
            <button type="button" class="px-4 py-2 rounded-lg border text-sm font-medium" onclick="toggleConnectionEdit('tvdb')">Cancel</button>
          </div>
          <p class="text-xs text-gray-500">
            TVDB requires attribution in the UI or documentation. We surface this on dashboards when TV data is displayed.
          </p>
        </form>
      </div>

      <% const tmdbConfigured = tmdbApiKey; %>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4">
        <div class="flex flex-wrap items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 font-semibold">TMDB</div>
            <div class="flex items-center gap-2 mt-1">
              <span class="text-sm font-semibold text-gray-900 dark:text-gray-100"><%= tmdbConfigured ? 'Connected' : 'Optional' %></span>
              <span class="px-2 py-0.5 text-[11px] rounded-full <%= tmdbConfigured ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700' %>">
                <%= tmdbConfigured ? 'Enabled' : 'Recommended' %>
              </span>
            </div>
            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Used for posters and movie lookups without TMDB IDs.</p>
          </div>
          <button type="button" data-connection-toggle="tmdb" onclick="toggleConnectionEdit('tmdb')" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700">
            <span class="edit-btn-label">Edit</span>
          </button>
        </div>
        <form id="tmdbForm" onsubmit="saveTmdbApiKey(event)" class="mt-4 hidden connection-form space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">TMDB API Key</label>
            <div class="relative">
              <input 
                type="password" 
                id="tmdbApiKey" 
                name="tmdbApiKey" 
                value="<%= tmdbApiKey %>" 
                placeholder="Enter TMDB API Key"
                class="w-full px-3 py-2 pr-16 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-900"
              >
              <button type="button" class="absolute inset-y-0 right-2 text-xs font-semibold text-blue-600 dark:text-blue-300" onclick="toggleSecret('tmdbApiKey', this)">Show</button>
            </div>
          </div>
          <div class="flex gap-3">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
              Save TMDB Key
            </button>
            <button type="button" class="px-4 py-2 rounded-lg border text-sm font-medium" onclick="toggleConnectionEdit('tmdb')">Cancel</button>
          </div>
        </form>
      </div>

      <% const omdbConfigured = omdbApiKey; %>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4">
        <div class="flex flex-wrap items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 font-semibold">OMDB</div>
            <div class="flex items-center gap-2 mt-1">
              <span class="text-sm font-semibold text-gray-900 dark:text-gray-100"><%= omdbConfigured ? 'Connected' : 'Optional' %></span>
              <span class="px-2 py-0.5 text-[11px] rounded-full <%= omdbConfigured ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700' %>">
                <%= omdbConfigured ? 'Enabled' : 'Recommended' %>
              </span>
            </div>
            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Higher IMDb lookup rate limits when configured.</p>
          </div>
          <button type="button" data-connection-toggle="omdb" onclick="toggleConnectionEdit('omdb')" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700">
            <span class="edit-btn-label">Edit</span>
          </button>
        </div>
        <form id="omdbForm" onsubmit="saveOmdbApiKey(event)" class="mt-4 hidden connection-form space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">OMDB API Key</label>
            <div class="relative">
              <input 
                type="password" 
                id="omdbApiKey" 
                name="omdbApiKey" 
                value="<%= omdbApiKey %>" 
                placeholder="Enter OMDB API Key (optional)"
                class="w-full px-3 py-2 pr-16 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-green-500 dark:bg-gray-900"
              >
              <button type="button" class="absolute inset-y-0 right-2 text-xs font-semibold text-green-600 dark:text-green-300" onclick="toggleSecret('omdbApiKey', this)">Show</button>
            </div>
          </div>
          <div class="flex gap-3">
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
              Save OMDB Key
            </button>
            <button type="button" class="px-4 py-2 rounded-lg border text-sm font-medium" onclick="toggleConnectionEdit('omdb')">Cancel</button>
          </div>
        </form>
      </div>

      <% const braveConfigured = braveApiKey; %>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4">
        <div class="flex flex-wrap items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 font-semibold">Brave Search</div>
            <div class="flex items-center gap-2 mt-1">
              <span class="text-sm font-semibold text-gray-900 dark:text-gray-100"><%= braveConfigured ? 'Connected' : 'Optional' %></span>
              <span class="px-2 py-0.5 text-[11px] rounded-full <%= braveConfigured ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700' %>">
                <%= braveConfigured ? 'Enabled' : 'Fallback option' %>
              </span>
            </div>
            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Used as a fallback to resolve IDs when other services fail.</p>
          </div>
          <button type="button" data-connection-toggle="brave" onclick="toggleConnectionEdit('brave')" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700">
            <span class="edit-btn-label">Edit</span>
          </button>
        </div>
        <form id="braveForm" onsubmit="saveBraveApiKey(event)" class="mt-4 hidden connection-form space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Brave Search API Key</label>
            <div class="relative">
              <input 
                type="password" 
                id="braveApiKey" 
                name="braveApiKey" 
                value="<%= braveApiKey %>" 
                placeholder="Enter Brave Search API Key (optional)"
                class="w-full px-3 py-2 pr-16 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-orange-500 dark:bg-gray-900"
              >
              <button type="button" class="absolute inset-y-0 right-2 text-xs font-semibold text-orange-600 dark:text-orange-300" onclick="toggleSecret('braveApiKey', this)">Show</button>
            </div>
          </div>
          <div class="flex gap-3">
            <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
              Save Brave Key
            </button>
            <button type="button" class="px-4 py-2 rounded-lg border text-sm font-medium" onclick="toggleConnectionEdit('brave')">Cancel</button>
          </div>
        </form>
      </div>
    </div>
    </div>

    <!-- Quality Settings Section -->
    <div id="section-quality" class="tab-content hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <form id="qualityForm" onsubmit="saveQualitySettings(event)">
        <!-- Resolution Rules -->
        <div class="mb-6">
          <h4 class="text-lg font-medium mb-3">Resolution Rules</h4>
          <div class="space-y-3">
            <% qualitySettings.resolutions.forEach(rule => { %>
              <div class="border rounded p-3">
                <div class="flex items-center space-x-4">
                  <label class="flex items-center">
                    <input type="checkbox" name="resolution_<%= rule.resolution %>_allowed" 
                           <%= rule.allowed ? 'checked' : '' %> 
                           class="mr-2">
                    <span class="font-medium"><%= rule.resolution %></span>
                  </label>
                  <div class="flex-1">
                    <label class="text-sm text-gray-600">Preferred Codecs (comma-separated):</label>
                    <input type="text" 
                           name="resolution_<%= rule.resolution %>_preferred" 
                           value="<%= rule.preferredCodecs ? rule.preferredCodecs.join(', ') : '' %>"
                           class="w-full border rounded px-2 py-1 text-sm">
                  </div>
                  <div class="flex-1">
                    <label class="text-sm text-gray-600">Discouraged Codecs (comma-separated):</label>
                    <input type="text" 
                           name="resolution_<%= rule.resolution %>_discouraged" 
                           value="<%= rule.discouragedCodecs ? rule.discouragedCodecs.join(', ') : '' %>"
                           class="w-full border rounded px-2 py-1 text-sm">
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        </div>

        <!-- Weights -->
        <div class="mb-6">
          <h4 class="text-lg font-medium mb-3">Quality Weights</h4>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">Resolution Weights (JSON):</label>
              <textarea name="resolutionWeights" rows="6" class="w-full border rounded px-2 py-1 font-mono text-sm"><%= JSON.stringify(qualitySettings.resolutionWeights, null, 2) %></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Source Tag Weights (JSON):</label>
              <textarea name="sourceTagWeights" rows="6" class="w-full border rounded px-2 py-1 font-mono text-sm"><%= JSON.stringify(qualitySettings.sourceTagWeights, null, 2) %></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Codec Weights (JSON):</label>
              <textarea name="codecWeights" rows="6" class="w-full border rounded px-2 py-1 font-mono text-sm"><%= JSON.stringify(qualitySettings.codecWeights, null, 2) %></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Audio Weights (JSON):</label>
              <textarea name="audioWeights" rows="6" class="w-full border rounded px-2 py-1 font-mono text-sm"><%= JSON.stringify(qualitySettings.audioWeights, null, 2) %></textarea>
            </div>
          </div>
        </div>

        <!-- Language Settings -->
        <div class="mb-6">
          <h4 class="text-lg font-medium mb-3">Language Settings</h4>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">Preferred Audio Languages (comma-separated, e.g., hi,en):</label>
              <input type="text" name="preferredAudioLanguages" 
                     value="<%= qualitySettings.preferredAudioLanguages.join(',') %>"
                     class="w-full border rounded px-2 py-1">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Preferred Language Bonus:</label>
              <input type="number" name="preferredLanguageBonus" 
                     value="<%= qualitySettings.preferredLanguageBonus %>"
                     class="w-full border rounded px-2 py-1">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Dubbed Penalty:</label>
              <input type="number" name="dubbedPenalty" 
                     value="<%= qualitySettings.dubbedPenalty %>"
                     class="w-full border rounded px-2 py-1">
            </div>
          </div>
        </div>

        <!-- Upgrade Settings -->
        <div class="mb-6">
          <h4 class="text-lg font-medium mb-3">Upgrade Settings</h4>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">Minimum Size Increase % for Upgrade:</label>
              <input type="number" name="minSizeIncreasePercentForUpgrade" 
                     value="<%= qualitySettings.minSizeIncreasePercentForUpgrade %>"
                     step="0.1"
                     class="w-full border rounded px-2 py-1">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Upgrade Threshold (score delta):</label>
              <input type="number" name="upgradeThreshold" 
                     value="<%= qualitySettings.upgradeThreshold %>"
                     step="0.1"
                     class="w-full border rounded px-2 py-1">
            </div>
            <div>
              <label class="flex items-center">
                <input type="checkbox" name="sizeBonusEnabled" 
                       <%= qualitySettings.sizeBonusEnabled ? 'checked' : '' %>
                       class="mr-2">
                <span>Enable Size Bonus</span>
              </label>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Poll Interval (minutes):</label>
              <input type="number" name="pollIntervalMinutes" 
                     value="<%= qualitySettings.pollIntervalMinutes %>"
                     class="w-full border rounded px-2 py-1">
              <p class="text-xs text-gray-500 mt-1">Note: This setting is deprecated. Use sync intervals below.</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Radarr Sync Interval (hours):</label>
              <input type="number" name="radarrSyncIntervalHours" 
                     value="<%= qualitySettings.radarrSyncIntervalHours || 6 %>"
                     min="1"
                     class="w-full border rounded px-2 py-1">
              <p class="text-xs text-gray-500 mt-1">How often to sync all movies from Radarr</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">RSS Sync Interval (hours):</label>
              <input type="number" name="rssSyncIntervalHours" 
                     value="<%= qualitySettings.rssSyncIntervalHours || 1 %>"
                     min="0.5"
                     step="0.5"
                     class="w-full border rounded px-2 py-1">
              <p class="text-xs text-gray-500 mt-1">How often to sync RSS feeds</p>
            </div>
          </div>
        </div>

        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded">
          Save Quality Settings
        </button>
      </form>
    </div>
    </main>
  </div>

  <!-- Add/Edit Feed Modal -->
  <div id="feedModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <h3 id="modalTitle" class="text-xl font-semibold mb-4">Add RSS Feed</h3>
      <form id="feedForm" onsubmit="saveFeed(event)">
        <input type="hidden" id="feedId" name="id">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Name:</label>
          <input type="text" id="feedName" name="name" required class="w-full border rounded px-2 py-1">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">URL:</label>
          <input type="url" id="feedUrl" name="url" required class="w-full border rounded px-2 py-1">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Feed Type:</label>
          <select id="feedType" name="feed_type" required class="w-full border rounded px-2 py-1">
            <option value="movie">Movie</option>
            <option value="tv">TV Show</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Select whether this feed contains movies or TV shows</p>
        </div>
        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="feedEnabled" name="enabled" checked class="mr-2">
            <span>Enabled</span>
          </label>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="hideFeedModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
            Cancel
          </button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Notification Container -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    // Toast Notification System (same as dashboard)
    function showToast(message, type = 'info', duration = 5000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      
      const bgColors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500',
      };
      
      const icons = {
        success: '✓',
        error: '✕',
        warning: '⚠',
        info: 'ℹ',
      };
      
      toast.className = `${bgColors[type] || bgColors.info} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 min-w-[300px] max-w-md toast-enter`;
      toast.innerHTML = `
        <span class="text-xl font-bold">${icons[type] || icons.info}</span>
        <span class="flex-1">${message}</span>
        <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200 font-bold text-xl">&times;</button>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('toast-enter');
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Confirmation Dialog System
    function showConfirm(message, onConfirm, onCancel = null) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
          <h3 class="text-lg font-semibold mb-4">Confirm</h3>
          <p class="text-gray-700 mb-6">${message}</p>
          <div class="flex justify-end space-x-3">
            <button class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
              Cancel
            </button>
            <button class="confirm-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
              Confirm
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      overlay.querySelector('.confirm-btn').addEventListener('click', () => {
        overlay.remove();
        if (onConfirm) onConfirm();
      });
      
      overlay.querySelector('.cancel-btn').addEventListener('click', () => {
        overlay.remove();
        if (onCancel) onCancel();
      });
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
          if (onCancel) onCancel();
        }
      });
    }

    async function saveTmdbApiKey(event) {
      event.preventDefault();
      console.log('saveTmdbApiKey called');
      const apiKey = document.getElementById('tmdbApiKey').value.trim();
      console.log('API Key length:', apiKey.length);
      const button = event.target.querySelector('button[type="submit"]');
      if (!button) {
        console.error('Button not found!');
        showToast('Error: Could not find save button', 'error');
        return;
      }
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Saving...';
      
      try {
        console.log('Sending request to /settings/tmdb-api-key');
        const res = await fetch('/settings/tmdb-api-key', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ apiKey }),
        });
        const data = await res.json();
        console.log('Response:', data);
        if (data.success) {
          showToast(data.message || 'TMDB API key saved successfully!', 'success');
          // Reload page after 1 second to show updated value
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          button.disabled = false;
          button.textContent = originalText;
        }
      } catch (error) {
        console.error('Error saving TMDB API key:', error);
        showToast('Error: ' + error.message, 'error');
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    async function saveOmdbApiKey(event) {
      event.preventDefault();
      console.log('saveOmdbApiKey called');
      const apiKey = document.getElementById('omdbApiKey').value.trim();
      console.log('API Key length:', apiKey.length);
      const button = event.target.querySelector('button[type="submit"]');
      if (!button) {
        console.error('Button not found!');
        showToast('Error: Could not find save button', 'error');
        return;
      }
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Saving...';
      
      try {
        console.log('Sending request to /settings/omdb-api-key');
        const res = await fetch('/settings/omdb-api-key', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ apiKey }),
        });
        const data = await res.json();
        console.log('Response:', data);
        if (data.success) {
          showToast(data.message || 'OMDB API key saved successfully!', 'success');
          // Reload page after 1 second to show updated value
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          button.disabled = false;
          button.textContent = originalText;
        }
      } catch (error) {
        console.error('Error saving OMDB API key:', error);
        showToast('Error: ' + error.message, 'error');
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    async function saveBraveApiKey(event) {
      event.preventDefault();
      console.log('saveBraveApiKey called');
      const apiKey = document.getElementById('braveApiKey').value.trim();
      console.log('API Key length:', apiKey.length);
      const button = event.target.querySelector('button[type="submit"]');
      if (!button) {
        console.error('Button not found!');
        showToast('Error: Could not find save button', 'error');
        return;
      }
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Saving...';
      
      try {
        console.log('Sending request to /settings/brave-api-key');
        const res = await fetch('/settings/brave-api-key', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ apiKey }),
        });
        const data = await res.json();
        console.log('Response:', data);
        if (data.success) {
          showToast(data.message || 'Brave Search API key saved successfully!', 'success');
          // Reload page after 1 second to show updated value
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          button.disabled = false;
          button.textContent = originalText;
        }
      } catch (error) {
        console.error('Error saving Brave API key:', error);
        showToast('Error: ' + error.message, 'error');
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    async function saveSonarrConfig(event) {
      event.preventDefault();
      const apiUrl = document.getElementById('sonarrApiUrl').value.trim();
      const apiKey = document.getElementById('sonarrApiKey').value.trim();

      if (!apiUrl || !apiKey) {
        showToast('Please enter both Sonarr API URL and API Key', 'warning');
        return;
      }

      const button = event.target.querySelector('button[type=\"submit\"]');
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Saving...';

      try {
        const res = await fetch('/settings/sonarr-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ apiUrl, apiKey })
        });
        const data = await res.json();
        if (data.success) {
          showToast(data.message || 'Sonarr configuration saved!', 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        showToast('Error saving Sonarr configuration: ' + (error.message || error), 'error');
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    async function saveTvdbConfig(event) {
      event.preventDefault();
      const apiKey = document.getElementById('tvdbApiKey').value.trim();
      const userPin = document.getElementById('tvdbUserPin').value.trim();

      if (!apiKey) {
        showToast('TVDB API key is required', 'warning');
        return;
      }

      const button = event.target.querySelector('button[type=\"submit\"]');
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Saving...';

      try {
        const res = await fetch('/settings/tvdb-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ apiKey, userPin })
        });
        const data = await res.json();
        if (data.success) {
          showToast(data.message || 'TVDB credentials saved!', 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        showToast('Error saving TVDB credentials: ' + (error.message || error), 'error');
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    async function saveRadarrConfig(event) {
      event.preventDefault();
      const apiUrl = document.getElementById('radarrApiUrl').value.trim();
      const apiKey = document.getElementById('radarrApiKey').value.trim();
      
      if (!apiUrl || !apiKey) {
        showToast('Please enter both Radarr API URL and API Key', 'warning');
        return;
      }

      const button = event.target.querySelector('button[type="submit"]');
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Saving...';

      try {
        const res = await fetch('/settings/radarr-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ apiUrl, apiKey }),
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || `HTTP ${res.status}: ${res.statusText}`);
        }
        
        if (data.success) {
          showToast('Radarr configuration saved successfully!', 'success');
          // Reload page after 1 second to show updated values
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast('Error: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Save Radarr config error:', error);
        showToast('Error saving configuration: ' + (error.message || 'Unknown error'), 'error');
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    function toggleConnectionEdit(key) {
      const form = document.getElementById(`${key}Form`);
      if (!form) return;

      const toggleBtn = document.querySelector(`[data-connection-toggle="${key}"]`);
      const label = toggleBtn?.querySelector('.edit-btn-label');

      const willShow = form.classList.contains('hidden');
      if (willShow) {
        form.classList.remove('hidden');
      } else {
        form.classList.add('hidden');
      }
      if (label) {
        label.textContent = willShow ? 'Close' : 'Edit';
      }
    }

    function toggleSecret(inputId, trigger) {
      const input = document.getElementById(inputId);
      if (!input) return;
      const isHidden = input.type === 'password';
      input.type = isHidden ? 'text' : 'password';
      if (trigger) {
        trigger.textContent = isHidden ? 'Hide' : 'Show';
      }
    }

    window.toggleConnectionEdit = toggleConnectionEdit;
    window.toggleSecret = toggleSecret;

    // Tab switching functionality
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      // Remove active state from all tabs
      document.querySelectorAll('[role="tab"]').forEach(button => {
        button.classList.remove('active-tab', 'bg-blue-500', 'text-white', 'shadow-sm', 'hover:bg-blue-600');
        button.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
        button.setAttribute('aria-selected', 'false');
      });
      
      // Show selected tab content
      const selectedContent = document.getElementById(`section-${tabName}`);
      if (selectedContent) {
        selectedContent.classList.remove('hidden');
      }
      
      // Activate selected tab button
      const selectedButton = document.getElementById(`tab-${tabName}`);
      if (selectedButton) {
        selectedButton.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
        selectedButton.classList.add('active-tab', 'bg-blue-500', 'text-white', 'shadow-sm', 'hover:bg-blue-600');
        selectedButton.setAttribute('aria-selected', 'true');
      }
    }
    
    // Make switchTab available globally
    window.switchTab = switchTab;

    let editingFeedId = null;

    function showAddFeedModal() {
      console.log('showAddFeedModal called');
      editingFeedId = null;
      const modal = document.getElementById('feedModal');
      if (!modal) {
        console.error('Feed modal not found!');
        showToast('Error: Feed modal not found', 'error');
        return;
      }
      document.getElementById('modalTitle').textContent = 'Add RSS Feed';
      document.getElementById('feedForm').reset();
      document.getElementById('feedId').value = '';
      document.getElementById('feedType').value = 'movie';
      document.getElementById('feedEnabled').checked = true;
      modal.classList.remove('hidden');
      console.log('Modal shown');
    }

    async function editFeed(id) {
      try {
        const res = await fetch(`/settings/feeds/${id}`);
        const data = await res.json();
        if (data.success && data.feed) {
          editingFeedId = id;
          document.getElementById('modalTitle').textContent = 'Edit RSS Feed';
          document.getElementById('feedId').value = data.feed.id;
          document.getElementById('feedName').value = data.feed.name;
          document.getElementById('feedUrl').value = data.feed.url;
          document.getElementById('feedType').value = data.feed.feed_type || 'movie';
          document.getElementById('feedEnabled').checked = data.feed.enabled;
          document.getElementById('feedModal').classList.remove('hidden');
        } else {
          showToast('Error loading feed', 'error');
        }
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    async function saveFeedDirectly(feed) {
      try {
        const url = feed.id ? `/settings/feeds/${feed.id}` : '/settings/feeds';
        const method = feed.id ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(feed)
        });
        const data = await res.json();
        if (data.success) {
          showToast('Feed saved successfully!', 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast('Error: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    async function saveFeed(event) {
      event.preventDefault();
      const form = event.target;
      const feed = {
        name: form.name.value,
        url: form.url.value,
        feed_type: form.feed_type.value,
        enabled: form.enabled.checked
      };
      if (editingFeedId) {
        feed.id = editingFeedId;
      }
      await saveFeedDirectly(feed);
      hideFeedModal();
    }

    function hideFeedModal() {
      document.getElementById('feedModal').classList.add('hidden');
    }

    async function deleteFeed(id) {
      showConfirm('Delete this feed?', async () => {
        try {
          const res = await fetch(`/settings/feeds/${id}`, { method: 'DELETE' });
          const data = await res.json();
          if (data.success) {
            showToast('Feed deleted successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          }
        } catch (error) {
          showToast('Error: ' + error.message, 'error');
        }
      });
    }

    async function saveQualitySettings(event) {
      event.preventDefault();
      const form = event.target;
      
      // Build resolution rules
      const resolutions = ['2160p', '1080p', '720p', '480p', 'UNKNOWN'].map(res => ({
        resolution: res,
        allowed: form[`resolution_${res}_allowed`]?.checked || false,
        preferredCodecs: form[`resolution_${res}_preferred`]?.value.split(',').map(s => s.trim()).filter(s => s) || [],
        discouragedCodecs: form[`resolution_${res}_discouraged`]?.value.split(',').map(s => s.trim()).filter(s => s) || []
      }));

      const settings = {
        resolutions,
        resolutionWeights: JSON.parse(form.resolutionWeights.value),
        sourceTagWeights: JSON.parse(form.sourceTagWeights.value),
        codecWeights: JSON.parse(form.codecWeights.value),
        audioWeights: JSON.parse(form.audioWeights.value),
        preferredAudioLanguages: form.preferredAudioLanguages.value.split(',').map(s => s.trim()).filter(s => s),
        preferredLanguageBonus: parseFloat(form.preferredLanguageBonus.value),
        dubbedPenalty: parseFloat(form.dubbedPenalty.value),
        sizeBonusEnabled: form.sizeBonusEnabled?.checked || false,
        minSizeIncreasePercentForUpgrade: parseFloat(form.minSizeIncreasePercentForUpgrade.value),
        upgradeThreshold: parseFloat(form.upgradeThreshold.value),
        pollIntervalMinutes: parseInt(form.pollIntervalMinutes.value, 10),
        radarrSyncIntervalHours: parseFloat(form.radarrSyncIntervalHours.value) || 6,
        rssSyncIntervalHours: parseFloat(form.rssSyncIntervalHours.value) || 1
      };

      try {
        const res = await fetch('/settings/quality', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        const data = await res.json();
        if (data.success) {
          showToast('Quality settings saved!', 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast('Error: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

  </script>
  <script src="/js/ui.js"></script>
</body>
</html>

