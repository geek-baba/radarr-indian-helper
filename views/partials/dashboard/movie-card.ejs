<%
  // Determine movie-level decision based on priority
  let decision = 'PENDING';
  let decisionReason = 'No releases found';
  let decisionBadgeClass = 'badge-info';
  
  if (movie.add && movie.add.length > 0) {
    decision = 'APPROVED';
    decisionReason = `${movie.add.length} new release(s) available`;
    decisionBadgeClass = 'badge-success';
  } else if (movie.upgrade && movie.upgrade.length > 0) {
    decision = 'UPGRADE';
    decisionReason = `${movie.upgrade.length} upgrade candidate(s)`;
    decisionBadgeClass = 'badge-warning';
  } else if (movie.existing && movie.existing.length > 0) {
    decision = 'EXISTING';
    decisionReason = 'Already in Radarr';
    decisionBadgeClass = 'badge-info';
  } else if (movie.ignored && movie.ignored.length > 0) {
    decision = 'IGNORED';
    decisionReason = 'All releases ignored (doesn\'t meet requirements)';
    decisionBadgeClass = 'badge-neutral';
  }
  
  // Get total release count
  const totalReleases = (movie.add?.length || 0) + (movie.existing?.length || 0) + (movie.upgrade?.length || 0) + (movie.ignored?.length || 0);
  
  // Get year from releases if not available
  let movieYear = null;
  if (movie.add && movie.add.length > 0 && movie.add[0].year) {
    movieYear = movie.add[0].year;
  } else if (movie.existing && movie.existing.length > 0 && movie.existing[0].year) {
    movieYear = movie.existing[0].year;
  } else if (movie.upgrade && movie.upgrade.length > 0 && movie.upgrade[0].year) {
    movieYear = movie.upgrade[0].year;
  }
%>

<article class="card overflow-hidden mb-4" 
         data-movie-id="<%= movie.tmdbId || 'unknown' %>"
         data-language="<%= (movie.originalLanguage || '').toLowerCase() %>"
         data-status="<%= decision.toLowerCase() %>">
  <div class="p-4 flex gap-4">
    <!-- Poster and Action Button -->
    <div class="flex-shrink-0 flex flex-col gap-3">
      <% if (movie.posterUrl) { %>
        <img 
          src="<%= movie.posterUrl %>" 
          alt="<%= movie.movieTitle %> poster" 
          class="w-28 h-40 object-cover rounded-xl shadow-lg"
          loading="lazy"
        />
      <% } else { %>
        <div class="w-28 h-40 bg-gray-200 dark:bg-gray-700 rounded-xl shadow-lg flex items-center justify-center text-gray-400 dark:text-gray-500 text-xs text-center p-2">
          No Poster
        </div>
      <% } %>
      
      <!-- Action Button Below Poster -->
      <% 
        // Determine primary action button
        let primaryRelease = null;
        let primaryAction = null;
        
        if (movie.add && movie.add.length > 0) {
          primaryRelease = movie.add[0];
          primaryAction = 'add';
        } else if (movie.upgrade && movie.upgrade.length > 0) {
          primaryRelease = movie.upgrade[0];
          primaryAction = 'upgrade';
        } else if (movie.ignored && movie.ignored.length > 0 && movie.tmdbId && !movie.radarrMovieId) {
          primaryRelease = movie.ignored[0];
          primaryAction = 'add';
        }
      %>
      
      <% if (primaryRelease && primaryAction === 'add') { %>
        <button 
          class="w-full px-3 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition-colors font-medium text-sm add-to-radarr" 
          data-id="<%= primaryRelease.id %>"
          onclick="addMovie(<%= primaryRelease.id %>)"
          aria-label="Add to Radarr"
        >
          Add to Radarr
        </button>
      <% } else if (primaryRelease && primaryAction === 'upgrade') { %>
        <button 
          class="w-full px-3 py-2 rounded-xl bg-orange-500 text-white hover:bg-orange-600 transition-colors font-medium text-sm" 
          onclick="upgradeMovie(<%= primaryRelease.id %>)"
          aria-label="Upgrade in Radarr"
        >
          Upgrade
        </button>
      <% } %>
    </div>

    <!-- Movie Info -->
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2 flex-wrap mb-2">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white truncate"><%= movie.movieTitle %></h3>
        
        <% if (movieYear) { %>
          <span class="badge badge-neutral"><%= movieYear %></span>
        <% } %>
        
        <% if (movie.originalLanguage) { %>
          <span class="badge badge-neutral uppercase"><%= movie.originalLanguage %></span>
        <% } %>

        <!-- Decision Badge -->
        <span class="badge <%= decisionBadgeClass %>" title="<%= decisionReason %>">
          <%= decision %>
        </span>

        <!-- IMDB Link -->
        <% if (movie.imdbId) { %>
          <a 
            href="https://www.imdb.com/title/<%= movie.imdbId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="Open IMDB"
            title="View on IMDB"
          >
            <span class="text-[10px] font-bold text-yellow-600 dark:text-yellow-400" style="font-family: Arial, sans-serif;">IMDb</span>
          </a>
        <% } %>

        <!-- TMDB Link -->
        <% if (movie.tmdbId) { %>
          <a 
            href="https://www.themoviedb.org/movie/<%= movie.tmdbId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="Open TMDB"
            title="View on TMDB"
          >
            <span class="text-[10px] font-bold text-blue-600 dark:text-blue-400" style="font-family: Arial, sans-serif;">TMDb</span>
          </a>
        <% } %>

        <!-- Radarr Link -->
        <% if (movie.radarrMovieId && typeof radarrBaseUrl !== 'undefined') { %>
          <a 
            href="<%= radarrBaseUrl %>/movie/<%= movie.radarrMovieId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="View in Radarr"
            title="View in Radarr"
          >
            <span class="text-[10px] font-bold text-[#3C85C6]" style="font-family: Arial, sans-serif;">Radarr</span>
          </a>
        <% } %>
      </div>

      <!-- Decision Reason (if ignored) -->
      <% if (decision === 'IGNORED' && decisionReason) { %>
        <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">Reason: <%= decisionReason %></div>
      <% } %>

      <!-- Radarr Info Section -->
      <% if (movie.radarrInfo) { %>
        <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
          <div class="text-sm font-semibold text-gray-900 dark:text-gray-100 mb-2">RADARR DATA</div>
          <div class="text-sm space-y-2">
            <% if (movie.radarrInfo.lastDownload && movie.radarrInfo.lastDownload.sourceTitle) { %>
              <div class="text-gray-700 dark:text-gray-300">
                <strong>Last Downloaded:</strong> 
                <span class="font-mono"><%= movie.radarrInfo.lastDownload.sourceTitle %></span>
                <% if (movie.radarrInfo.lastDownload.date) { %>
                  <span class="text-gray-500 dark:text-gray-400 text-xs ml-2">(<%= new Date(movie.radarrInfo.lastDownload.date).toLocaleDateString() %>)</span>
                <% } %>
                <% if (movie.radarrInfo.lastDownload.releaseGroup) { %>
                  <span class="text-gray-500 dark:text-gray-400 text-xs ml-1">[<%= movie.radarrInfo.lastDownload.releaseGroup %>]</span>
                <% } %>
              </div>
            <% } else if (movie.radarrInfo.fileName) { %>
              <div class="text-gray-700 dark:text-gray-300">
                <strong>Radarr File:</strong> 
                <span class="font-mono"><%= movie.radarrInfo.fileName %></span>
              </div>
            <% } else if (movie.radarrInfo.path) { %>
              <div class="text-gray-700 dark:text-gray-300">
                <strong>Radarr Path:</strong> 
                <span class="font-mono"><%= movie.radarrInfo.path.split('/').pop() %></span>
              </div>
            <% } %>
            <% if (movie.radarrInfo.resolution || movie.radarrInfo.codec || movie.radarrInfo.sourceTag || movie.radarrInfo.audio || movie.radarrInfo.sizeMb) { %>
              <div class="flex flex-wrap gap-2 items-center">
                <% if (movie.radarrInfo.resolution && movie.radarrInfo.resolution !== 'UNKNOWN') { %>
                  <div class="flex items-center gap-1 px-2 py-1 bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 rounded text-xs">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="3" width="18" height="18" rx="2"/>
                      <path d="M3 9h18M9 3v18"/>
                    </svg>
                    <span><%= movie.radarrInfo.resolution %></span>
                  </div>
                <% } %>
                <% if (movie.radarrInfo.codec && movie.radarrInfo.codec !== 'UNKNOWN') { %>
                  <div class="flex items-center gap-1 px-2 py-1 bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-200 rounded text-xs">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                    <span><%= movie.radarrInfo.codec %></span>
                  </div>
                <% } %>
                <% if (movie.radarrInfo.sourceTag && movie.radarrInfo.sourceTag !== 'OTHER') { %>
                  <div class="flex items-center gap-1 px-2 py-1 bg-purple-100 dark:bg-purple-900/40 text-purple-800 dark:text-purple-200 rounded text-xs">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                      <circle cx="12" cy="10" r="3"/>
                    </svg>
                    <span><%= movie.radarrInfo.sourceTag %></span>
                  </div>
                <% } %>
                <% if (movie.radarrInfo.audio && movie.radarrInfo.audio !== 'Unknown') { %>
                  <div class="flex items-center gap-1 px-2 py-1 bg-yellow-100 dark:bg-yellow-900/40 text-yellow-800 dark:text-yellow-200 rounded text-xs">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                      <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                    </svg>
                    <span><%= movie.radarrInfo.audio %></span>
                  </div>
                <% } %>
                <% if (movie.radarrInfo.sizeMb) { %>
                  <div class="flex items-center gap-1 px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded text-xs">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                      <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                      <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                    <span><%= typeof movie.radarrInfo.sizeMb === 'number' ? movie.radarrInfo.sizeMb.toFixed(2) : movie.radarrInfo.sizeMb %> MB</span>
                  </div>
                <% } %>
              </div>
            <% } %>
          </div>
        </div>
      <% } %>

      <!-- Release Table -->
      <div class="mt-3">
        <%- include('release-table', { movie }) %>
      </div>
    </div>
  </div>
</article>

