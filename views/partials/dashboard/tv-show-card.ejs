<%
  // Determine show-level decision based on status (matching Movies structure)
  let decision = 'PENDING';
  let decisionReason = 'No releases found';
  let decisionBadgeClass = 'badge-info';
  
  if (show.newShows && show.newShows.length > 0) {
    decision = 'NEW';
    decisionReason = `${show.newShows.length} new release(s) available`;
    decisionBadgeClass = 'badge-success';
  } else if (show.existingShows && show.existingShows.length > 0) {
    decision = 'EXISTING';
    decisionReason = 'Already in Sonarr';
    decisionBadgeClass = 'badge-info';
  } else if (show.unmatched && show.unmatched.length > 0) {
    decision = 'UNMATCHED';
    decisionReason = 'No TVDB/TMDB ID found';
    decisionBadgeClass = 'badge-neutral';
  }
  
  // Get total release count
  const totalReleases = (show.newShows?.length || 0) + (show.existingShows?.length || 0) + (show.unmatched?.length || 0);
  
  // Get all releases for display
  const allReleases = [...(show.newShows || []), ...(show.existingShows || []), ...(show.unmatched || [])];
%>

<article class="card overflow-hidden mb-4" 
         data-show-id="<%= show.tvdbId || show.tmdbId || 'unknown' %>"
         data-status="<%= decision.toLowerCase() %>">
  <div class="p-4 flex gap-4">
    <!-- Poster and Action Button -->
    <div class="flex-shrink-0 flex flex-col gap-3">
      <% if (show.posterUrl) { %>
        <img 
          src="<%= show.posterUrl %>" 
          alt="<%= show.showName %> poster" 
          class="w-28 h-40 object-cover rounded-xl shadow-lg"
          loading="lazy"
        />
      <% } else { %>
        <div class="w-28 h-40 bg-gray-200 dark:bg-gray-700 rounded-xl shadow-lg flex items-center justify-center text-gray-400 dark:text-gray-500 text-xs text-center p-2">
          No Poster
        </div>
      <% } %>
      
      <!-- Action Button Below Poster -->
      <% 
        // Determine primary action button - show "Add to Sonarr" for new shows (not in Sonarr)
        let primaryRelease = null;
        let primaryAction = null;
        
        if (show.newShows && show.newShows.length > 0 && !show.sonarrSeriesId) {
          primaryRelease = show.newShows[0];
          primaryAction = 'add';
        }
      %>
      
      <% if (primaryRelease && primaryAction === 'add') { %>
        <button 
          class="w-full px-3 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition-colors font-medium text-sm add-to-sonarr" 
          data-id="<%= primaryRelease.id %>"
          onclick="addTvShow(<%= primaryRelease.id %>)"
          aria-label="Add to Sonarr"
        >
          Add to Sonarr
        </button>
      <% } %>
      <% if (!show.manuallyIgnored && show.ignoreReleaseId) { %>
        <button 
          class="w-full px-3 py-2 rounded-xl bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors font-medium text-sm"
          onclick="ignoreTvShow(<%= show.ignoreReleaseId %>)"
          aria-label="Ignore TV show"
        >
          Ignore Show
        </button>
      <% } %>
    </div>

    <!-- Show Info -->
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2 flex-wrap mb-2">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white truncate"><%= show.showName %></h3>
        
        <!-- Decision Badge -->
        <span class="badge <%= decisionBadgeClass %>" title="<%= decisionReason %>">
          <%= decision.replace('_', ' ') %>
        </span>

        <!-- TVDB Link -->
        <% if (show.tvdbId && show.tvdbUrl) { %>
          <a 
            href="<%= show.tvdbUrl %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="Open TVDB"
            title="View on TVDB"
          >
            <span class="text-[10px] font-bold text-blue-600 dark:text-blue-400" style="font-family: Arial, sans-serif;">TVDB</span>
          </a>
        <% } %>

        <!-- TMDB Link -->
        <% if (show.tmdbId) { %>
          <a 
            href="https://www.themoviedb.org/tv/<%= show.tmdbId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="Open TMDB"
            title="View on TMDB"
          >
            <span class="text-[10px] font-bold text-blue-600 dark:text-blue-400" style="font-family: Arial, sans-serif;">TMDb</span>
          </a>
        <% } %>

        <!-- IMDB Link -->
        <% if (show.imdbId) { %>
          <a 
            href="https://www.imdb.com/title/<%= show.imdbId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="Open IMDB"
            title="View on IMDB"
          >
            <span class="text-[10px] font-bold text-yellow-600 dark:text-yellow-400" style="font-family: Arial, sans-serif;">IMDb</span>
          </a>
        <% } %>

        <!-- Sonarr Link -->
        <% if (show.sonarrSeriesId && typeof sonarrBaseUrl !== 'undefined' && sonarrBaseUrl) { %>
          <a 
            href="<%= sonarrBaseUrl %>/series/<%= show.sonarrSeriesId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="View in Sonarr"
            title="View in Sonarr"
          >
            <span class="text-[10px] font-bold text-[#3C85C6]" style="font-family: Arial, sans-serif;">Sonarr</span>
          </a>
        <% } %>
      </div>

      <!-- Decision Reason -->
      <% if (decisionReason) { %>
        <div class="mt-1 text-xs text-gray-500 dark:text-gray-400"><%= decisionReason %></div>
      <% } %>

      <!-- Releases List -->
      <div class="mt-3 space-y-2">
        <% allReleases.forEach((release, index) => { %>
          <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
            <div class="flex items-start justify-between gap-2 mb-2">
              <div class="flex-1 min-w-0">
                <div class="font-medium text-sm text-gray-900 dark:text-white truncate">
                  <%= release.title || release.show_name || 'Unknown Release' %>
                </div>
                <% if (release.season_number !== null && release.season_number !== undefined) { %>
                  <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                    Season <%= release.season_number %>
                  </div>
                <% } %>
              </div>
              <div class="flex items-center gap-2 flex-shrink-0">
                <% if (release.status === 'NEW_SHOW' || release.status === 'NEW_SEASON') { %>
                  <span class="badge badge-success text-xs">NEW</span>
                <% } else if (release.status === 'IGNORED' || release.status === 'ADDED') { %>
                  <span class="badge badge-info text-xs">EXISTING</span>
                <% } else { %>
                  <span class="badge badge-neutral text-xs">UNMATCHED</span>
                <% } %>
              </div>
            </div>
            
            <!-- Release Metadata -->
            <div class="flex flex-wrap gap-1 items-center text-xs">
              <% if (release.feedName) { %>
                <span class="px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">
                  <%= release.feedName %>
                </span>
              <% } %>
              <% if (release.published_at) { %>
                <span class="text-gray-500 dark:text-gray-400">
                  <%= new Date(release.published_at).toLocaleDateString() %>
                </span>
              <% } %>
            </div>
            
            <!-- Release Link -->
            <% if (release.link) { %>
              <div class="mt-2">
                <a 
                  href="<%= release.link %>" 
                  target="_blank" 
                  rel="noreferrer"
                  class="text-xs text-blue-600 dark:text-blue-400 hover:underline"
                >
                  View Release
                </a>
              </div>
            <% } %>
          </div>
        <% }); %>
      </div>
    </div>
  </div>
</article>

