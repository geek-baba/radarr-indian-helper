<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Radarr Indian Helper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    .toast-enter {
      animation: slideIn 0.3s ease-out;
    }
    .toast-exit {
      animation: slideOut 0.3s ease-in;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Toast Notification Container -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
  <%- include('partials/sidebar', { currentPage: 'dashboard' }) %>
  
  <main class="ml-64 p-8">
    <div class="mb-6 flex justify-between items-center">
      <h2 class="text-2xl font-bold">Dashboard</h2>
      <div class="flex items-center gap-4">
        <div id="progressContainer" class="hidden flex-1 max-w-md">
          <div class="bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <div id="progressText" class="text-xs text-gray-600 mt-1"></div>
        </div>
        <button onclick="refreshDashboard()" id="refreshButton" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
          Refresh Dashboard
        </button>
      </div>
    </div>

    <% 
      const hasNewMovies = newMoviesByPeriod && (
        (newMoviesByPeriod.today && newMoviesByPeriod.today.length > 0) ||
        (newMoviesByPeriod.yesterday && newMoviesByPeriod.yesterday.length > 0) ||
        (newMoviesByPeriod.older && newMoviesByPeriod.older.length > 0)
      );
      const hasExistingMovies = existingMoviesByPeriod && (
        (existingMoviesByPeriod.today && existingMoviesByPeriod.today.length > 0) ||
        (existingMoviesByPeriod.yesterday && existingMoviesByPeriod.yesterday.length > 0) ||
        (existingMoviesByPeriod.older && existingMoviesByPeriod.older.length > 0)
      );
      const hasUnmatched = unmatchedItems && unmatchedItems.length > 0;
      const hasIgnored = ignoredItems && ignoredItems.length > 0;
    %>

    <% if (!hasNewMovies && !hasExistingMovies && !hasUnmatched && !hasIgnored) { %>
      <p class="text-gray-600">No releases found. Go to Settings to add RSS feeds and sync data.</p>
    <% } else { %>
      
      <!-- Top-level Tabs -->
      <div class="mb-6 border-b border-gray-200">
        <nav class="flex space-x-8" aria-label="Main Sections">
          <% 
            const mainTabs = [
              { key: 'new', label: 'New Movies', count: (newMoviesByPeriod.today?.length || 0) + (newMoviesByPeriod.yesterday?.length || 0) + (newMoviesByPeriod.older?.length || 0), visible: hasNewMovies },
              { key: 'existing', label: 'Existing Movies', count: (existingMoviesByPeriod.today?.length || 0) + (existingMoviesByPeriod.yesterday?.length || 0) + (existingMoviesByPeriod.older?.length || 0), visible: hasExistingMovies },
              { key: 'unmatched', label: 'Unmatched Items', count: unmatchedItems?.length || 0, visible: hasUnmatched },
              { key: 'ignored', label: 'Ignored Items', count: ignoredItems?.length || 0, visible: hasIgnored }
            ];
            let firstVisibleTab = mainTabs.findIndex(tab => tab.visible);
            if (firstVisibleTab === -1) firstVisibleTab = 0;
          %>
          <% mainTabs.forEach((tab, index) => { %>
            <% if (tab.visible) { %>
              <button 
                onclick="showMainSection('<%= tab.key %>')" 
                id="main-tab-<%= tab.key %>"
                class="<%= index === firstVisibleTab ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' %> py-4 px-1 border-b-2 font-medium text-sm"
              >
                <%= tab.label %> (<%= tab.count %>)
              </button>
            <% } %>
          <% }); %>
        </nav>
      </div>

      <!-- New Movies Section -->
      <% if (hasNewMovies) { %>
        <div id="main-section-new" class="main-section <%= firstVisibleTab === 0 ? '' : 'hidden' %>">
          <!-- Time Period Tabs for New Movies -->
          <div class="mb-4 border-b border-gray-200">
            <nav class="flex space-x-8" aria-label="Time Periods">
              <% const newPeriods = [
                { key: 'today', label: 'Today', count: newMoviesByPeriod.today?.length || 0 },
                { key: 'yesterday', label: 'Yesterday', count: newMoviesByPeriod.yesterday?.length || 0 },
                { key: 'older', label: 'Older', count: newMoviesByPeriod.older?.length || 0 }
              ]; %>
              <% 
                let firstNewIndex = -1;
                newPeriods.forEach((period, index) => {
                  if (period.count > 0 && firstNewIndex === -1) {
                    firstNewIndex = index;
                  }
                });
              %>
              <% newPeriods.forEach((period, index) => { %>
                <% if (period.count > 0) { %>
                  <button 
                    onclick="showNewMoviesPeriod('<%= period.key %>')" 
                    id="new-tab-<%= period.key %>"
                    class="<%= index === firstNewIndex ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' %> py-2 px-1 border-b-2 font-medium text-sm"
                  >
                    <%= period.label %> (<%= period.count %>)
                  </button>
                <% } %>
              <% }); %>
            </nav>
          </div>

          <!-- New Movies Time Period Sections -->
          <% newPeriods.forEach((period, index) => { %>
            <% if (newMoviesByPeriod[period.key] && newMoviesByPeriod[period.key].length > 0) { %>
              <div id="new-period-<%= period.key %>" class="new-movies-section <%= index === firstNewIndex ? '' : 'hidden' %>">
                <% newMoviesByPeriod[period.key].forEach(movie => { %>
                  <%- include('partials/movie-card', { movie, radarrBaseUrl }) %>
                <% }); %>
              </div>
            <% } %>
          <% }); %>
        </div>
      <% } %>

      <!-- Existing Movies Section -->
      <% if (hasExistingMovies) { %>
        <div id="main-section-existing" class="main-section <%= firstVisibleTab === 1 ? '' : 'hidden' %>">
          <!-- Time Period Tabs for Existing Movies -->
          <div class="mb-4 border-b border-gray-200">
            <nav class="flex space-x-8" aria-label="Time Periods">
              <% const existingPeriods = [
                { key: 'today', label: 'Today', count: existingMoviesByPeriod.today?.length || 0 },
                { key: 'yesterday', label: 'Yesterday', count: existingMoviesByPeriod.yesterday?.length || 0 },
                { key: 'older', label: 'Older', count: existingMoviesByPeriod.older?.length || 0 }
              ]; %>
              <% 
                let firstExistingIndex = -1;
                existingPeriods.forEach((period, index) => {
                  if (period.count > 0 && firstExistingIndex === -1) {
                    firstExistingIndex = index;
                  }
                });
              %>
              <% existingPeriods.forEach((period, index) => { %>
                <% if (period.count > 0) { %>
                  <button 
                    onclick="showExistingMoviesPeriod('<%= period.key %>')" 
                    id="existing-tab-<%= period.key %>"
                    class="<%= index === firstExistingIndex ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' %> py-2 px-1 border-b-2 font-medium text-sm"
                  >
                    <%= period.label %> (<%= period.count %>)
                  </button>
                <% } %>
              <% }); %>
            </nav>
          </div>

          <!-- Existing Movies Time Period Sections -->
          <% existingPeriods.forEach((period, index) => { %>
            <% if (existingMoviesByPeriod[period.key] && existingMoviesByPeriod[period.key].length > 0) { %>
              <div id="existing-period-<%= period.key %>" class="existing-movies-section <%= index === firstExistingIndex ? '' : 'hidden' %>">
                <% existingMoviesByPeriod[period.key].forEach(movie => { %>
                  <%- include('partials/movie-card', { movie, radarrBaseUrl }) %>
                <% }); %>
              </div>
            <% } %>
          <% }); %>
        </div>
      <% } %>

      <!-- Unmatched Items Section -->
      <% if (hasUnmatched) { %>
        <div id="main-section-unmatched" class="main-section <%= firstVisibleTab === 2 ? '' : 'hidden' %>">
          <% unmatchedItems.forEach(movie => { %>
            <%- include('partials/movie-card', { movie, radarrBaseUrl }) %>
          <% }); %>
        </div>
      <% } %>

      <!-- Ignored Items Section -->
      <% if (hasIgnored) { %>
        <div id="main-section-ignored" class="main-section <%= firstVisibleTab === 3 ? '' : 'hidden' %>">
          <div class="mb-4">
            <p class="text-gray-600">These items were ignored because they don't meet quality requirements or are below upgrade thresholds.</p>
          </div>
          <% ignoredItems.forEach(movie => { %>
            <%- include('partials/movie-card', { movie, radarrBaseUrl }) %>
          <% }); %>
        </div>
      <% } %>

    <% } %>
  </main>

  <!-- Add Movie Modal -->
  <div id="addMovieModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <h3 class="text-xl font-semibold mb-4">Add Movie to Radarr</h3>
      <form id="addMovieForm" onsubmit="submitAddMovie(event)">
        <input type="hidden" id="addMovieReleaseId" name="releaseId">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Quality Profile:</label>
          <select id="qualityProfileSelect" name="qualityProfileId" required class="w-full border rounded px-2 py-1">
            <option value="">Loading...</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Root Folder:</label>
          <select id="rootFolderSelect" name="rootFolderPath" required class="w-full border rounded px-2 py-1">
            <option value="">Loading...</option>
          </select>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="hideAddMovieModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
            Cancel
          </button>
          <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
            Add
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Toast Notification System
    function showToast(message, type = 'info', duration = 5000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      
      const bgColors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500',
      };
      
      const icons = {
        success: '✓',
        error: '✕',
        warning: '⚠',
        info: 'ℹ',
      };
      
      toast.className = `${bgColors[type] || bgColors.info} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 min-w-[300px] max-w-md toast-enter`;
      toast.innerHTML = `
        <span class="text-xl font-bold">${icons[type] || icons.info}</span>
        <span class="flex-1">${message}</span>
        <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200 font-bold text-xl">&times;</button>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('toast-enter');
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Confirmation Dialog System
    function showConfirm(message, onConfirm, onCancel = null) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
          <h3 class="text-lg font-semibold mb-4">Confirm</h3>
          <p class="text-gray-700 mb-6">${message}</p>
          <div class="flex justify-end space-x-3">
            <button class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
              Cancel
            </button>
            <button class="confirm-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
              Confirm
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      overlay.querySelector('.confirm-btn').addEventListener('click', () => {
        overlay.remove();
        if (onConfirm) onConfirm();
      });
      
      overlay.querySelector('.cancel-btn').addEventListener('click', () => {
        overlay.remove();
        if (onCancel) onCancel();
      });
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
          if (onCancel) onCancel();
        }
      });
    }

    // Main section tab switching
    function showMainSection(section) {
      // Hide all main sections
      document.querySelectorAll('.main-section').forEach(section => {
        section.classList.add('hidden');
      });
      // Show selected section
      document.getElementById(`main-section-${section}`).classList.remove('hidden');
      
      // Update tab styles
      document.querySelectorAll('[id^="main-tab-"]').forEach(tab => {
        tab.classList.remove('border-blue-500', 'text-blue-600');
        tab.classList.add('border-transparent', 'text-gray-500');
      });
      document.getElementById(`main-tab-${section}`).classList.remove('border-transparent', 'text-gray-500');
      document.getElementById(`main-tab-${section}`).classList.add('border-blue-500', 'text-blue-600');
    }

    // Tab switching for New Movies
    function showNewMoviesPeriod(period) {
      // Hide all new movie sections
      document.querySelectorAll('.new-movies-section').forEach(section => {
        section.classList.add('hidden');
      });
      // Show selected section
      document.getElementById(`new-period-${period}`).classList.remove('hidden');
      
      // Update tab styles
      document.querySelectorAll('[id^="new-tab-"]').forEach(tab => {
        tab.classList.remove('border-blue-500', 'text-blue-600');
        tab.classList.add('border-transparent', 'text-gray-500');
      });
      document.getElementById(`new-tab-${period}`).classList.remove('border-transparent', 'text-gray-500');
      document.getElementById(`new-tab-${period}`).classList.add('border-blue-500', 'text-blue-600');
    }

    // Tab switching for Existing Movies
    function showExistingMoviesPeriod(period) {
      // Hide all existing movie sections
      document.querySelectorAll('.existing-movies-section').forEach(section => {
        section.classList.add('hidden');
      });
      // Show selected section
      document.getElementById(`existing-period-${period}`).classList.remove('hidden');
      
      // Update tab styles
      document.querySelectorAll('[id^="existing-tab-"]').forEach(tab => {
        tab.classList.remove('border-blue-500', 'text-blue-600');
        tab.classList.add('border-transparent', 'text-gray-500');
      });
      document.getElementById(`existing-tab-${period}`).classList.remove('border-transparent', 'text-gray-500');
      document.getElementById(`existing-tab-${period}`).classList.add('border-blue-500', 'text-blue-600');
    }

    let currentReleaseId = null;
    let radarrOptions = null;

    async function loadRadarrOptions() {
      if (radarrOptions) return radarrOptions;
      
      try {
        const res = await fetch('/actions/radarr-options');
        const data = await res.json();
        if (data.success) {
          radarrOptions = data;
          return data;
        } else {
          throw new Error(data.error || 'Failed to load options');
        }
      } catch (error) {
        console.error('Error loading Radarr options:', error);
        showToast('Error loading Radarr options: ' + error.message, 'error');
        return null;
      }
    }

    async function addMovie(id) {
      currentReleaseId = id;
      
      const options = await loadRadarrOptions();
      if (!options) return;

      const qualitySelect = document.getElementById('qualityProfileSelect');
      qualitySelect.innerHTML = '';
      options.qualityProfiles.forEach(profile => {
        const option = document.createElement('option');
        option.value = profile.id;
        option.textContent = profile.name;
        qualitySelect.appendChild(option);
      });

      const rootFolderSelect = document.getElementById('rootFolderSelect');
      rootFolderSelect.innerHTML = '';
      options.rootFolders.forEach(folder => {
        const option = document.createElement('option');
        option.value = folder.path;
        option.textContent = folder.path;
        rootFolderSelect.appendChild(option);
      });

      document.getElementById('addMovieModal').classList.remove('hidden');
      document.getElementById('addMovieReleaseId').value = id;
    }

    function hideAddMovieModal() {
      document.getElementById('addMovieModal').classList.add('hidden');
      currentReleaseId = null;
    }

    async function submitAddMovie(event) {
      event.preventDefault();
      
      const releaseId = document.getElementById('addMovieReleaseId').value;
      const qualityProfileId = document.getElementById('qualityProfileSelect').value;
      const rootFolderPath = document.getElementById('rootFolderSelect').value;

      if (!qualityProfileId || !rootFolderPath) {
        showToast('Please select both quality profile and root folder', 'warning');
        return;
      }

      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Adding...';

      try {
        const res = await fetch(`/actions/${releaseId}/add`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qualityProfileId, rootFolderPath }),
        });
        const data = await res.json();
        if (data.success) {
          showToast(data.message || 'Movie added to Radarr!', 'success');
          hideAddMovieModal();
          setTimeout(() => location.reload(), 1500);
        } else {
          showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }

    async function upgradeMovie(id) {
      showConfirm('Trigger upgrade search in Radarr?', async () => {
        try {
          const res = await fetch(`/actions/${id}/upgrade`, { method: 'POST' });
          const data = await res.json();
          if (data.success) {
            showToast(data.message || 'Upgrade search triggered!', 'success');
            setTimeout(() => location.reload(), 1500);
          } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          }
        } catch (error) {
          showToast('Error: ' + error.message, 'error');
        }
      });
    }

    async function ignoreRelease(id) {
      showConfirm('Ignore this release?', async () => {
        try {
          const res = await fetch(`/actions/${id}/ignore`, { method: 'POST' });
          const data = await res.json();
          if (data.success) {
            showToast('Release ignored successfully', 'success');
            setTimeout(() => location.reload(), 1500);
          } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          }
        } catch (error) {
          showToast('Error: ' + error.message, 'error');
        }
      });
    }

    let refreshInterval = null;

    async function refreshDashboard() {
      const refreshButton = document.getElementById('refreshButton');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      
      refreshButton.disabled = true;
      refreshButton.textContent = 'Refreshing...';
      progressContainer.classList.remove('hidden');
      
      try {
        const res = await fetch('/refresh', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });
        const data = await res.json();
        if (data.success) {
          showToast('Dashboard refresh started', 'success', 3000);
          // Start polling for progress
          refreshInterval = setInterval(pollRefreshProgress, 1000);
        } else {
          showToast('Failed to start refresh: ' + (data.message || 'Unknown error'), 'error');
          refreshButton.disabled = false;
          refreshButton.textContent = 'Refresh Dashboard';
          progressContainer.classList.add('hidden');
        }
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
        refreshButton.disabled = false;
        refreshButton.textContent = 'Refresh Dashboard';
        progressContainer.classList.add('hidden');
      }
    }

    async function pollRefreshProgress() {
      try {
        const res = await fetch('/refresh/progress');
        const data = await res.json();
        
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const refreshButton = document.getElementById('refreshButton');
        const progressContainer = document.getElementById('progressContainer');
        
        if (data.isRunning) {
          const percent = data.total > 0 ? (data.current / data.total) * 100 : 0;
          progressBar.style.width = `${percent}%`;
          progressText.textContent = data.message || 'Processing...';
        } else {
          // Refresh complete
          clearInterval(refreshInterval);
          refreshInterval = null;
          progressBar.style.width = '100%';
          progressText.textContent = data.message || 'Complete';
          refreshButton.disabled = false;
          refreshButton.textContent = 'Refresh Dashboard';
          
          // Reload page after a short delay
          setTimeout(() => {
            location.reload();
          }, 2000);
        }
      } catch (error) {
        console.error('Error polling progress:', error);
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

  </script>
</body>
</html>
