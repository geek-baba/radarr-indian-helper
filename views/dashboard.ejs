<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Radarr Indian Helper</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-gray-800 text-white">
    <div class="container mx-auto px-4 py-3">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">Radarr Indian Helper</h1>
        <div class="space-x-4">
          <a href="/" class="hover:text-gray-300">Dashboard</a>
          <a href="/settings" class="hover:text-gray-300">Settings</a>
        </div>
      </div>
    </div>
  </nav>
  <main class="container mx-auto px-4 py-8">
    <div class="mb-6 flex justify-between items-center">
      <h2 class="text-2xl font-bold">Dashboard</h2>
      <button onclick="refreshFeeds()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
        Refresh Feeds
      </button>
    </div>

    <% if (!movieGroups || movieGroups.length === 0) { %>
      <p class="text-gray-600">No releases found. Go to Settings to add RSS feeds and refresh.</p>
    <% } else { %>
      <% movieGroups.forEach(movie => { %>
        <div class="mb-8 bg-white rounded-lg shadow">
          <!-- Movie Header: Single poster and metadata -->
          <div class="p-6 border-b border-gray-200">
            <div class="flex gap-6">
              <!-- Poster -->
              <div class="flex-shrink-0">
                <% if (movie.posterUrl) { %>
                  <img src="<%= movie.posterUrl %>" alt="<%= movie.movieTitle %>" class="w-32 h-48 object-cover rounded shadow">
                <% } else { %>
                  <div class="w-32 h-48 bg-gray-200 rounded shadow flex items-center justify-center text-gray-400 text-xs text-center p-2">No Poster</div>
                <% } %>
              </div>
              
              <!-- Movie Info -->
              <div class="flex-1">
                <h3 class="text-2xl font-bold mb-3"><%= movie.movieTitle %></h3>
                        <div class="flex flex-wrap gap-4 text-sm items-center">
                          <% if (movie.imdbId) { %>
                            <a href="https://www.imdb.com/title/<%= movie.imdbId %>" target="_blank" class="text-blue-600 hover:underline">IMDB</a>
                          <% } %>
                          <% if (movie.tmdbId) { %>
                            <a href="https://www.themoviedb.org/movie/<%= movie.tmdbId %>" target="_blank" class="text-blue-600 hover:underline">TMDB</a>
                            <button onclick="overrideTmdbIdForMovie(<%= (movie.add[0] || movie.existing[0] || movie.upgrade[0])?.id || 0 %>)" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs" title="Override TMDB ID">
                              Override TMDB
                            </button>
                          <% } else { %>
                            <button onclick="overrideTmdbIdForMovie(<%= (movie.add[0] || movie.existing[0] || movie.upgrade[0])?.id || 0 %>)" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs" title="Override TMDB ID">
                              Override TMDB
                            </button>
                          <% } %>
                          <% if (movie.originalLanguage) { %>
                            <span class="text-gray-600">Language: <%= movie.originalLanguage %></span>
                          <% } %>
                          <% if (movie.radarrMovieId && typeof radarrBaseUrl !== 'undefined') { %>
                            <a href="<%= radarrBaseUrl %>/movie/<%= movie.radarrMovieId %>" target="_blank" class="text-blue-600 hover:underline">View in Radarr ðŸ”—</a>
                          <% } %>
                        </div>
                
                <!-- Summary counts and Radarr info -->
                <div class="mt-4 space-y-3">
                  <div class="flex gap-4 text-sm">
                    <% if (movie.add.length > 0) { %>
                      <span class="px-3 py-1 bg-green-100 text-green-800 rounded">Add: <%= movie.add.length %></span>
                    <% } %>
                    <% if (movie.existing.length > 0) { %>
                      <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded">Existing: <%= movie.existing.length %></span>
                    <% } %>
                    <% if (movie.upgrade.length > 0) { %>
                      <span class="px-3 py-1 bg-orange-100 text-orange-800 rounded">Upgrade: <%= movie.upgrade.length %></span>
                    <% } %>
                  </div>
                  
                  <!-- Radarr Info -->
                  <% if (movie.radarrInfo) { %>
                    <div class="text-sm">
                      <div class="text-gray-700 mb-1">
                        <strong>Radarr:</strong>
                        <% if (movie.radarrInfo.lastDownload) { %>
                          <%= movie.radarrInfo.lastDownload.sourceTitle %> - Downloaded <%= new Date(movie.radarrInfo.lastDownload.date).toLocaleDateString() %>
                        <% } else if (movie.radarrInfo.path) { %>
                          <%= movie.radarrInfo.path.split('/').pop() %>
                        <% } %>
                      </div>
                      <div class="flex flex-wrap gap-1">
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs"><%= movie.radarrInfo.resolution || 'N/A' %></span>
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs"><%= movie.radarrInfo.codec || 'UNKNOWN' %></span>
                        <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs"><%= movie.radarrInfo.sourceTag || 'OTHER' %></span>
                        <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs"><%= movie.radarrInfo.audio || 'Unknown' %></span>
                        <% if (movie.radarrInfo.sizeMb) { %>
                          <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs"><%= movie.radarrInfo.sizeMb.toFixed(2) %> MB</span>
                        <% } %>
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>

          <!-- Releases List: All releases in a table format -->
          <div class="p-6">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Release Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attributes</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <!-- Add Releases -->
                  <% movie.add.forEach(release => { %>
                    <tr class="bg-green-50">
                      <td class="px-4 py-3 text-sm">
                        <span class="font-medium"><%= release.feedName || release.source_site %></span>
                        <div class="text-xs text-gray-500"><%= new Date(release.published_at).toLocaleString() %></div>
                        <% if (release.link) { %>
                          <a href="<%= release.link %>" target="_blank" class="text-blue-600 hover:underline text-xs">ðŸ”—</a>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm font-mono text-gray-800"><%= release.title %></td>
                      <td class="px-4 py-3 text-sm">
                        <div class="flex flex-wrap gap-1">
                          <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs"><%= release.resolution %></span>
                          <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs"><%= release.codec %></span>
                          <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs"><%= release.source_tag %></span>
                          <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs"><%= release.audio %></span>
                          <% if (release.rss_size_mb) { %>
                            <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs"><%= release.rss_size_mb.toFixed(2) %> MB</span>
                          <% } %>
                        </div>
                        <% if (release.audio_languages) { %>
                          <div class="text-xs text-gray-600 mt-1">Languages: <%= JSON.parse(release.audio_languages).join(', ') %></div>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 bg-green-200 text-green-800 rounded text-xs uppercase">NEW</span>
                      </td>
                      <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="addMovie(<%= release.id %>)" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs">
                          Add to Radarr
                        </button>
                        <button onclick="ignoreRelease(<%= release.id %>)" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs">
                          Ignore
                        </button>
                      </td>
                    </tr>
                  <% }); %>

                  <!-- Existing Releases -->
                  <% movie.existing.forEach(release => { %>
                    <tr class="bg-blue-50">
                      <td class="px-4 py-3 text-sm">
                        <span class="font-medium"><%= release.feedName || release.source_site %></span>
                        <div class="text-xs text-gray-500"><%= new Date(release.published_at).toLocaleString() %></div>
                        <% if (release.link) { %>
                          <a href="<%= release.link %>" target="_blank" class="text-blue-600 hover:underline text-xs">ðŸ”—</a>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm font-mono text-gray-800"><%= release.title %></td>
                      <td class="px-4 py-3 text-sm">
                        <div class="flex flex-wrap gap-1">
                          <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs"><%= release.resolution %></span>
                          <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs"><%= release.codec %></span>
                          <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs"><%= release.source_tag %></span>
                          <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs"><%= release.audio %></span>
                          <% if (release.rss_size_mb) { %>
                            <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs"><%= release.rss_size_mb.toFixed(2) %> MB</span>
                          <% } %>
                        </div>
                        <% if (release.audio_languages) { %>
                          <div class="text-xs text-gray-600 mt-1">Languages: <%= JSON.parse(release.audio_languages).join(', ') %></div>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 bg-blue-200 text-blue-800 rounded text-xs uppercase">EXISTING</span>
                        <% if (release.status === 'IGNORED') { %>
                          <div class="text-xs text-gray-500 mt-1">(Below upgrade thresholds)</div>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="ignoreRelease(<%= release.id %>)" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs">
                          Ignore
                        </button>
                      </td>
                    </tr>
                  <% }); %>

                  <!-- Upgrade Releases -->
                  <% movie.upgrade.forEach(release => { %>
                    <tr class="bg-orange-50">
                      <td class="px-4 py-3 text-sm">
                        <span class="font-medium"><%= release.feedName || release.source_site %></span>
                        <div class="text-xs text-gray-500"><%= new Date(release.published_at).toLocaleString() %></div>
                        <% if (release.link) { %>
                          <a href="<%= release.link %>" target="_blank" class="text-blue-600 hover:underline text-xs">ðŸ”—</a>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm font-mono text-gray-800"><%= release.title %></td>
                      <td class="px-4 py-3 text-sm">
                        <div class="flex flex-wrap gap-1">
                          <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs"><%= release.resolution %></span>
                          <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs"><%= release.codec %></span>
                          <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs"><%= release.source_tag %></span>
                          <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs"><%= release.audio %></span>
                          <% if (release.rss_size_mb) { %>
                            <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs"><%= release.rss_size_mb.toFixed(2) %> MB</span>
                          <% } %>
                        </div>
                        <% if (release.audio_languages) { %>
                          <div class="text-xs text-gray-600 mt-1">Languages: <%= JSON.parse(release.audio_languages).join(', ') %></div>
                        <% } %>
                        <% if (release.radarr_existing_quality_score !== null && release.new_quality_score !== null) { %>
                          <div class="text-xs mt-1 text-gray-600">
                            <span>Score: <%= release.radarr_existing_quality_score.toFixed(2) %></span>
                            <span class="mx-1">â†’</span>
                            <span class="text-green-600 font-semibold"><%= release.new_quality_score.toFixed(2) %></span>
                            <span class="text-blue-600">(Î”<%= (release.new_quality_score - release.radarr_existing_quality_score).toFixed(2) %>)</span>
                          </div>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 bg-orange-200 text-orange-800 rounded text-xs uppercase">UPGRADE</span>
                      </td>
                      <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="upgradeMovie(<%= release.id %>)" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-xs">
                          Upgrade
                        </button>
                        <button onclick="ignoreRelease(<%= release.id %>)" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs">
                          Ignore
                        </button>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      <% }); %>
    <% } %>
  </main>

  <script>
    async function addMovie(id) {
      if (!confirm('Add this movie to Radarr?')) return;
      try {
        const res = await fetch(`/actions/${id}/add`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          alert('Movie added to Radarr!');
          location.reload();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function upgradeMovie(id) {
      if (!confirm('Trigger upgrade search in Radarr?')) return;
      try {
        const res = await fetch(`/actions/${id}/upgrade`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          alert('Upgrade search triggered!');
          location.reload();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function ignoreRelease(id) {
      if (!confirm('Ignore this release?')) return;
      try {
        const res = await fetch(`/actions/${id}/ignore`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          location.reload();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

            async function refreshFeeds() {
              if (!confirm('Refresh all RSS feeds? This may take a while.')) return;
              try {
                const res = await fetch('/settings/refresh', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                  alert('Feed refresh started! The page will refresh in a few seconds.');
                  setTimeout(() => location.reload(), 5000);
                } else {
                  alert('Error: ' + (data.error || 'Unknown error'));
                }
              } catch (error) {
                alert('Error: ' + error.message);
              }
            }

            async function overrideTmdbId(id) {
              const tmdbId = prompt('Enter TMDB ID to override:');
              if (!tmdbId || isNaN(parseInt(tmdbId, 10))) {
                alert('Please enter a valid TMDB ID (numeric)');
                return;
              }
              
              if (!confirm(`Override TMDB ID to ${tmdbId}?`)) return;
              
              try {
                const res = await fetch(`/actions/${id}/override-tmdb`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ tmdbId }),
                });
                const data = await res.json();
                if (data.success) {
                  alert(`TMDB ID updated to ${tmdbId} (${data.tmdbTitle || ''})`);
                  location.reload();
                } else {
                  alert('Error: ' + (data.error || 'Unknown error'));
                }
              } catch (error) {
                alert('Error: ' + error.message);
              }
            }

            async function overrideTmdbIdForMovie(releaseId) {
              if (!releaseId || releaseId === 0) {
                alert('No release found for this movie. Please use the Override TMDB button on a specific release.');
                return;
              }
              await overrideTmdbId(releaseId);
            }
  </script>
</body>
</html>
