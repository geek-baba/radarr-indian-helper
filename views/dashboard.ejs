<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Radarr Indian Helper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    .toast-enter {
      animation: slideIn 0.3s ease-out;
    }
    .toast-exit {
      animation: slideOut 0.3s ease-in;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Toast Notification Container -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
  <nav class="bg-gray-800 text-white">
    <div class="container mx-auto px-4 py-3">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">Radarr Indian Helper</h1>
        <div class="space-x-4">
          <a href="/" class="hover:text-gray-300 font-semibold">Dashboard</a>
          <a href="/data/radarr" class="hover:text-gray-300">Radarr Data</a>
          <a href="/data/rss" class="hover:text-gray-300">RSS Data</a>
          <a href="/settings" class="hover:text-gray-300">Settings</a>
        </div>
      </div>
    </div>
  </nav>
  <main class="container mx-auto px-4 py-8">
    <div class="mb-6 flex justify-between items-center">
      <h2 class="text-2xl font-bold">Dashboard</h2>
      <div class="flex items-center gap-4">
        <div id="refreshStats" class="text-sm text-gray-600 hidden"></div>
        <button onclick="refreshFeeds()" id="refreshButton" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
          Refresh Feeds
        </button>
      </div>
    </div>

    <% if (!movieGroupsByPeriod || Object.keys(movieGroupsByPeriod).every(period => movieGroupsByPeriod[period].length === 0)) { %>
      <p class="text-gray-600">No releases found. Go to Settings to add RSS feeds and refresh.</p>
    <% } else { %>
      <!-- Time Period Tabs -->
      <div class="mb-6 border-b border-gray-200">
        <nav class="flex space-x-8" aria-label="Time Periods">
          <% const periods = [
            { key: 'today', label: 'Today', count: movieGroupsByPeriod.today?.length || 0 },
            { key: 'yesterday', label: 'Yesterday', count: movieGroupsByPeriod.yesterday?.length || 0 },
            { key: 'thisWeek', label: 'This Week', count: movieGroupsByPeriod.thisWeek?.length || 0 },
            { key: 'lastWeek', label: 'Last Week', count: movieGroupsByPeriod.lastWeek?.length || 0 },
            { key: 'older', label: 'Older', count: movieGroupsByPeriod.older?.length || 0 }
          ]; %>
          <% 
            let firstVisibleIndex = -1;
            periods.forEach((period, index) => {
              if (period.count > 0 && firstVisibleIndex === -1) {
                firstVisibleIndex = index;
              }
            });
          %>
          <% periods.forEach((period, index) => { %>
            <% if (period.count > 0) { %>
              <button 
                onclick="showTimePeriod('<%= period.key %>')" 
                id="tab-<%= period.key %>"
                class="<%= index === firstVisibleIndex ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' %> py-4 px-1 border-b-2 font-medium text-sm"
              >
                <%= period.label %> (<%= period.count %>)
              </button>
            <% } %>
          <% }); %>
        </nav>
      </div>

      <!-- Time Period Sections -->
      <% periods.forEach((period, index) => { %>
        <% if (movieGroupsByPeriod[period.key] && movieGroupsByPeriod[period.key].length > 0) { %>
          <div id="period-<%= period.key %>" class="time-period-section <%= index === firstVisibleIndex ? '' : 'hidden' %>">
            <% movieGroupsByPeriod[period.key].forEach(movie => { %>
        <div class="mb-8 bg-white rounded-lg shadow">
          <!-- Movie Header: Single poster and metadata -->
          <div class="p-6 border-b border-gray-200">
            <div class="flex gap-6">
              <!-- Poster -->
              <div class="flex-shrink-0">
                <% if (movie.posterUrl) { %>
                  <img src="<%= movie.posterUrl %>" alt="<%= movie.movieTitle %>" class="w-32 h-48 object-cover rounded shadow">
                <% } else { %>
                  <div class="w-32 h-48 bg-gray-200 rounded shadow flex items-center justify-center text-gray-400 text-xs text-center p-2">No Poster</div>
                <% } %>
              </div>
              
              <!-- Movie Info -->
              <div class="flex-1">
                <h3 class="text-2xl font-bold mb-3"><%= movie.movieTitle %></h3>
                        <div class="flex flex-wrap gap-4 text-sm items-center">
                          <% if (movie.imdbId) { %>
                            <a href="https://www.imdb.com/title/<%= movie.imdbId %>" target="_blank" class="text-blue-600 hover:underline">IMDB</a>
                          <% } %>
                          <% if (movie.tmdbId) { %>
                            <a href="https://www.themoviedb.org/movie/<%= movie.tmdbId %>" target="_blank" class="text-blue-600 hover:underline">TMDB</a>
                            <button onclick="overrideTmdbIdForMovie(<%= (movie.add[0] || movie.existing[0] || movie.upgrade[0])?.id || 0 %>)" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs" title="Override TMDB ID">
                              Override TMDB
                            </button>
                          <% } else { %>
                            <button onclick="overrideTmdbIdForMovie(<%= (movie.add[0] || movie.existing[0] || movie.upgrade[0])?.id || 0 %>)" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs" title="Override TMDB ID">
                              Override TMDB
                            </button>
                          <% } %>
                          <% if (movie.originalLanguage) { %>
                            <span class="text-gray-600">Language: <%= movie.originalLanguage %></span>
                          <% } %>
                          <% if (movie.radarrMovieId && typeof radarrBaseUrl !== 'undefined') { %>
                            <a href="<%= radarrBaseUrl %>/movie/<%= movie.radarrMovieId %>" target="_blank" class="text-blue-600 hover:underline">View in Radarr ðŸ”—</a>
                          <% } %>
                        </div>
                
                <!-- Summary counts and Radarr info -->
                <div class="mt-4 space-y-3">
                  <div class="flex gap-4 text-sm">
                    <% if (movie.add.length > 0) { %>
                      <span class="px-3 py-1 bg-green-100 text-green-800 rounded">Add: <%= movie.add.length %></span>
                    <% } %>
                    <% if (movie.existing.length > 0) { %>
                      <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded">Existing: <%= movie.existing.length %></span>
                    <% } %>
                    <% if (movie.upgrade.length > 0) { %>
                      <span class="px-3 py-1 bg-orange-100 text-orange-800 rounded">Upgrade: <%= movie.upgrade.length %></span>
                    <% } %>
                  </div>
                  
                  <!-- Radarr Info -->
                  <% if (movie.radarrInfo) { %>
                    <div class="text-sm">
                      <div class="text-gray-700 mb-1">
                        <strong>Radarr:</strong>
                        <% if (movie.radarrInfo.lastDownload) { %>
                          <%= movie.radarrInfo.lastDownload.sourceTitle %> - Downloaded <%= new Date(movie.radarrInfo.lastDownload.date).toLocaleDateString() %>
                        <% } else if (movie.radarrInfo.path) { %>
                          <%= movie.radarrInfo.path.split('/').pop() %>
                        <% } %>
                      </div>
                      <div class="flex flex-wrap gap-1">
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs"><%= movie.radarrInfo.resolution || 'N/A' %></span>
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs"><%= movie.radarrInfo.codec || 'UNKNOWN' %></span>
                        <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs"><%= movie.radarrInfo.sourceTag || 'OTHER' %></span>
                        <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs"><%= movie.radarrInfo.audio || 'Unknown' %></span>
                        <% if (movie.radarrInfo.sizeMb) { %>
                          <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs"><%= movie.radarrInfo.sizeMb.toFixed(2) %> MB</span>
                        <% } %>
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>

          <!-- Releases List: All releases in a table format -->
          <div class="p-6">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Release Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attributes</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <!-- Add Releases -->
                  <% movie.add.forEach(release => { %>
                    <tr class="bg-green-50">
                      <td class="px-4 py-3 text-sm">
                        <span class="font-medium"><%= release.feedName || release.source_site %></span>
                        <div class="text-xs text-gray-500"><%= new Date(release.published_at).toLocaleString() %></div>
                        <% if (release.link) { %>
                          <a href="<%= release.link %>" target="_blank" class="text-blue-600 hover:underline text-xs">ðŸ”—</a>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm font-mono text-gray-800"><%= release.title %></td>
                      <td class="px-4 py-3 text-sm">
                        <div class="flex flex-wrap gap-1">
                          <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs"><%= release.resolution %></span>
                          <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs"><%= release.codec %></span>
                          <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs"><%= release.source_tag %></span>
                          <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs"><%= release.audio %></span>
                          <% if (release.rss_size_mb) { %>
                            <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs"><%= release.rss_size_mb.toFixed(2) %> MB</span>
                          <% } %>
                        </div>
                        <% if (release.audio_languages) { %>
                          <div class="text-xs text-gray-600 mt-1">Languages: <%= JSON.parse(release.audio_languages).join(', ') %></div>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm">
                        <% if (release.status === 'ATTENTION_NEEDED') { %>
                          <span class="px-2 py-1 bg-yellow-200 text-yellow-800 rounded text-xs uppercase">ATTENTION NEEDED</span>
                          <div class="text-xs text-gray-500 mt-1">(No TMDB match)</div>
                        <% } else { %>
                          <span class="px-2 py-1 bg-green-200 text-green-800 rounded text-xs uppercase">NEW</span>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="addMovie(<%= release.id %>)" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs">
                          Add to Radarr
                        </button>
                        <button onclick="ignoreRelease(<%= release.id %>)" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs">
                          Ignore
                        </button>
                      </td>
                    </tr>
                  <% }); %>

                  <!-- Existing Releases -->
                  <% movie.existing.forEach(release => { %>
                    <tr class="bg-blue-50">
                      <td class="px-4 py-3 text-sm">
                        <span class="font-medium"><%= release.feedName || release.source_site %></span>
                        <div class="text-xs text-gray-500"><%= new Date(release.published_at).toLocaleString() %></div>
                        <% if (release.link) { %>
                          <a href="<%= release.link %>" target="_blank" class="text-blue-600 hover:underline text-xs">ðŸ”—</a>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm font-mono text-gray-800"><%= release.title %></td>
                      <td class="px-4 py-3 text-sm">
                        <div class="flex flex-wrap gap-1">
                          <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs"><%= release.resolution %></span>
                          <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs"><%= release.codec %></span>
                          <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs"><%= release.source_tag %></span>
                          <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs"><%= release.audio %></span>
                          <% if (release.rss_size_mb) { %>
                            <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs"><%= release.rss_size_mb.toFixed(2) %> MB</span>
                          <% } %>
                        </div>
                        <% if (release.audio_languages) { %>
                          <div class="text-xs text-gray-600 mt-1">Languages: <%= JSON.parse(release.audio_languages).join(', ') %></div>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 bg-blue-200 text-blue-800 rounded text-xs uppercase">EXISTING</span>
                        <% if (release.status === 'IGNORED') { %>
                          <div class="text-xs text-gray-500 mt-1">(Below upgrade thresholds)</div>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="ignoreRelease(<%= release.id %>)" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs">
                          Ignore
                        </button>
                      </td>
                    </tr>
                  <% }); %>

                  <!-- Upgrade Releases -->
                  <% movie.upgrade.forEach(release => { %>
                    <tr class="bg-orange-50">
                      <td class="px-4 py-3 text-sm">
                        <span class="font-medium"><%= release.feedName || release.source_site %></span>
                        <div class="text-xs text-gray-500"><%= new Date(release.published_at).toLocaleString() %></div>
                        <% if (release.link) { %>
                          <a href="<%= release.link %>" target="_blank" class="text-blue-600 hover:underline text-xs">ðŸ”—</a>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm font-mono text-gray-800"><%= release.title %></td>
                      <td class="px-4 py-3 text-sm">
                        <div class="flex flex-wrap gap-1">
                          <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs"><%= release.resolution %></span>
                          <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs"><%= release.codec %></span>
                          <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs"><%= release.source_tag %></span>
                          <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs"><%= release.audio %></span>
                          <% if (release.rss_size_mb) { %>
                            <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs"><%= release.rss_size_mb.toFixed(2) %> MB</span>
                          <% } %>
                        </div>
                        <% if (release.audio_languages) { %>
                          <div class="text-xs text-gray-600 mt-1">Languages: <%= JSON.parse(release.audio_languages).join(', ') %></div>
                        <% } %>
                        <% if (release.radarr_existing_quality_score !== null && release.new_quality_score !== null) { %>
                          <div class="text-xs mt-1 text-gray-600">
                            <span>Score: <%= release.radarr_existing_quality_score.toFixed(2) %></span>
                            <span class="mx-1">â†’</span>
                            <span class="text-green-600 font-semibold"><%= release.new_quality_score.toFixed(2) %></span>
                            <span class="text-blue-600">(Î”<%= (release.new_quality_score - release.radarr_existing_quality_score).toFixed(2) %>)</span>
                          </div>
                        <% } %>
                      </td>
                      <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 bg-orange-200 text-orange-800 rounded text-xs uppercase">UPGRADE</span>
                      </td>
                      <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="upgradeMovie(<%= release.id %>)" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-xs">
                          Upgrade
                        </button>
                        <button onclick="ignoreRelease(<%= release.id %>)" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs">
                          Ignore
                        </button>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
            <% }); %>
          </div>
        <% } %>
      <% }); %>
    <% } %>
  </main>

  <!-- Add Movie Modal -->
  <div id="addMovieModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <h3 class="text-xl font-semibold mb-4">Add Movie to Radarr</h3>
      <form id="addMovieForm" onsubmit="submitAddMovie(event)">
        <input type="hidden" id="addMovieReleaseId" name="releaseId">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Quality Profile:</label>
          <select id="qualityProfileSelect" name="qualityProfileId" required class="w-full border rounded px-2 py-1">
            <option value="">Loading...</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Root Folder:</label>
          <select id="rootFolderSelect" name="rootFolderPath" required class="w-full border rounded px-2 py-1">
            <option value="">Loading...</option>
          </select>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="hideAddMovieModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
            Cancel
          </button>
          <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
            Add to Radarr
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Toast Notification System
    function showToast(message, type = 'info', duration = 5000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      
      const bgColors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500',
      };
      
      const icons = {
        success: 'âœ“',
        error: 'âœ•',
        warning: 'âš ',
        info: 'â„¹',
      };
      
      toast.className = `${bgColors[type] || bgColors.info} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 min-w-[300px] max-w-md toast-enter`;
      toast.innerHTML = `
        <span class="text-xl font-bold">${icons[type] || icons.info}</span>
        <span class="flex-1">${message}</span>
        <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200 font-bold text-xl">&times;</button>
      `;
      
      container.appendChild(toast);
      
      // Auto remove after duration
      setTimeout(() => {
        toast.classList.remove('toast-enter');
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Confirmation Dialog System
    function showConfirm(message, onConfirm, onCancel = null) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
          <h3 class="text-lg font-semibold mb-4">Confirm</h3>
          <p class="text-gray-700 mb-6">${message}</p>
          <div class="flex justify-end space-x-3">
            <button class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
              Cancel
            </button>
            <button class="confirm-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
              Confirm
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      overlay.querySelector('.confirm-btn').addEventListener('click', () => {
        overlay.remove();
        if (onConfirm) onConfirm();
      });
      
      overlay.querySelector('.cancel-btn').addEventListener('click', () => {
        overlay.remove();
        if (onCancel) onCancel();
      });
      
      // Close on overlay click
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
          if (onCancel) onCancel();
        }
      });
    }

    let currentReleaseId = null;
    let radarrOptions = null;

    async function loadRadarrOptions() {
      if (radarrOptions) return radarrOptions;
      
      try {
        const res = await fetch('/actions/radarr-options');
        const data = await res.json();
        if (data.success) {
          radarrOptions = data;
          return data;
        } else {
          throw new Error(data.error || 'Failed to load options');
        }
      } catch (error) {
        console.error('Error loading Radarr options:', error);
        showToast('Error loading Radarr options: ' + error.message, 'error');
        return null;
      }
    }

    async function addMovie(id) {
      currentReleaseId = id;
      
      // Load Radarr options
      const options = await loadRadarrOptions();
      if (!options) return;

      // Populate quality profiles
      const qualitySelect = document.getElementById('qualityProfileSelect');
      qualitySelect.innerHTML = '';
      options.qualityProfiles.forEach(profile => {
        const option = document.createElement('option');
        option.value = profile.id;
        option.textContent = profile.name;
        qualitySelect.appendChild(option);
      });

      // Populate root folders
      const rootFolderSelect = document.getElementById('rootFolderSelect');
      rootFolderSelect.innerHTML = '';
      options.rootFolders.forEach(folder => {
        const option = document.createElement('option');
        option.value = folder.path;
        option.textContent = folder.path;
        rootFolderSelect.appendChild(option);
      });

      // Show modal
      document.getElementById('addMovieModal').classList.remove('hidden');
      document.getElementById('addMovieReleaseId').value = id;
    }

    function hideAddMovieModal() {
      document.getElementById('addMovieModal').classList.add('hidden');
      currentReleaseId = null;
    }

    async function submitAddMovie(event) {
      event.preventDefault();
      
      const releaseId = document.getElementById('addMovieReleaseId').value;
      const qualityProfileId = document.getElementById('qualityProfileSelect').value;
      const rootFolderPath = document.getElementById('rootFolderSelect').value;

      if (!qualityProfileId || !rootFolderPath) {
        showToast('Please select both quality profile and root folder', 'warning');
        return;
      }

      // Disable submit button
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Adding...';

      try {
        const res = await fetch(`/actions/${releaseId}/add`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qualityProfileId, rootFolderPath }),
        });
        const data = await res.json();
        if (data.success) {
          showToast(data.message || 'Movie added to Radarr!', 'success');
          hideAddMovieModal();
          setTimeout(() => location.reload(), 1500);
        } else {
          showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }

    async function upgradeMovie(id) {
      showConfirm('Trigger upgrade search in Radarr?', async () => {
        try {
          const res = await fetch(`/actions/${id}/upgrade`, { method: 'POST' });
          const data = await res.json();
          if (data.success) {
            showToast(data.message || 'Upgrade search triggered!', 'success');
            setTimeout(() => location.reload(), 1500);
          } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          }
        } catch (error) {
          showToast('Error: ' + error.message, 'error');
        }
      });
    }

    async function ignoreRelease(id) {
      showConfirm('Ignore this release?', async () => {
        try {
          const res = await fetch(`/actions/${id}/ignore`, { method: 'POST' });
          const data = await res.json();
          if (data.success) {
            showToast('Release ignored successfully', 'success');
            setTimeout(() => location.reload(), 1500);
          } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          }
        } catch (error) {
          showToast('Error: ' + error.message, 'error');
        }
      });
    }

            let refreshInterval = null;

            async function refreshFeeds() {
              showConfirm('Refresh all RSS feeds? This may take a while.', async () => {
                const refreshButton = document.getElementById('refreshButton');
                const refreshStats = document.getElementById('refreshStats');
                
                refreshButton.disabled = true;
                refreshButton.textContent = 'Refreshing...';
                refreshStats.classList.remove('hidden');
                
                try {
                  const res = await fetch('/settings/refresh', { method: 'POST' });
                  const data = await res.json();
                  if (data.success) {
                    showToast('Feed refresh started!', 'info');
                    
                    // Poll for stats every 2 seconds
                    refreshInterval = setInterval(async () => {
                      try {
                        const statsRes = await fetch('/settings/refresh/stats');
                        const statsData = await statsRes.json();
                        if (statsData.success && statsData.stats) {
                          const s = statsData.stats;
                          if (s.isRunning) {
                            const progress = s.totalFeeds > 0 
                              ? `${s.feedsProcessed}/${s.totalFeeds} feeds`
                              : 'Starting...';
                            refreshStats.innerHTML = `
                              <span class="font-medium">${s.currentFeed || 'Processing...'}</span>
                              <span class="text-gray-500">(${progress})</span>
                              <span class="ml-2">New: ${s.newCount} | Upgrade: ${s.upgradeCount} | Ignored: ${s.ignoredCount}</span>
                            `;
                          } else {
                            // Refresh complete
                            clearInterval(refreshInterval);
                            refreshButton.disabled = false;
                            refreshButton.textContent = 'Refresh Feeds';
                            refreshStats.innerHTML = `
                              <span class="text-green-600 font-medium">
                                Complete! New: ${s.newCount} | Upgrade: ${s.upgradeCount} | Ignored: ${s.ignoredCount}
                              </span>
                            `;
                            setTimeout(() => {
                              location.reload();
                            }, 2000);
                          }
                        }
                      } catch (error) {
                        console.error('Error fetching refresh stats:', error);
                      }
                    }, 2000);
                  } else {
                    showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                    refreshButton.disabled = false;
                    refreshButton.textContent = 'Refresh Feeds';
                    refreshStats.classList.add('hidden');
                  }
                } catch (error) {
                  showToast('Error: ' + error.message, 'error');
                  refreshButton.disabled = false;
                  refreshButton.textContent = 'Refresh Feeds';
                  refreshStats.classList.add('hidden');
                }
              });
            }

            async function overrideTmdbId(id) {
              // Create a modal for TMDB ID input
              const overlay = document.createElement('div');
              overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
              overlay.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
                  <h3 class="text-lg font-semibold mb-4">Override TMDB ID</h3>
                  <input type="text" id="tmdbIdInput" placeholder="Enter TMDB ID" class="w-full border rounded px-3 py-2 mb-4" autofocus>
                  <div class="flex justify-end space-x-3">
                    <button class="cancel-tmdb-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                      Cancel
                    </button>
                    <button class="confirm-tmdb-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                      Override
                    </button>
                  </div>
                </div>
              `;
              
              document.body.appendChild(overlay);
              
              const input = overlay.querySelector('#tmdbIdInput');
              input.focus();
              
              overlay.querySelector('.confirm-tmdb-btn').addEventListener('click', async () => {
                const tmdbId = input.value.trim();
                if (!tmdbId || isNaN(parseInt(tmdbId, 10))) {
                  showToast('Please enter a valid TMDB ID (numeric)', 'warning');
                  return;
                }
                
                overlay.remove();
                
                showConfirm(`Override TMDB ID to ${tmdbId}?`, async () => {
                  try {
                    const res = await fetch(`/actions/${id}/override-tmdb`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ tmdbId }),
                    });
                    const data = await res.json();
                    if (data.success) {
                      showToast(`TMDB ID updated to ${tmdbId} (${data.tmdbTitle || ''})`, 'success');
                      setTimeout(() => location.reload(), 1500);
                    } else {
                      showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                    }
                  } catch (error) {
                    showToast('Error: ' + error.message, 'error');
                  }
                });
              });
              
              overlay.querySelector('.cancel-tmdb-btn').addEventListener('click', () => {
                overlay.remove();
              });
              
              overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
              });
              
              input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                  overlay.querySelector('.confirm-tmdb-btn').click();
                }
              });
            }

            async function overrideTmdbIdForMovie(releaseId) {
              if (!releaseId || releaseId === 0) {
                showToast('No release found for this movie. Please use the Override TMDB button on a specific release.', 'warning');
                return;
              }
              await overrideTmdbId(releaseId);
            }

            function showTimePeriod(period) {
              // Hide all time period sections
              document.querySelectorAll('.time-period-section').forEach(section => {
                section.classList.add('hidden');
              });
              
              // Show selected time period
              const selectedSection = document.getElementById(`period-${period}`);
              if (selectedSection) {
                selectedSection.classList.remove('hidden');
              }
              
              // Update tab styles
              document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
              });
              
              const selectedTab = document.getElementById(`tab-${period}`);
              if (selectedTab) {
                selectedTab.classList.remove('border-transparent', 'text-gray-500');
                selectedTab.classList.add('border-blue-500', 'text-blue-600');
              }
            }
  </script>
</body>
</html>
